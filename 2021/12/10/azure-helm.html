<!doctype html><html lang=zh-cn dir=content/zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests">
<title> Azure-Helm Lab - 路无止境！ </title>
<meta name=keywords content="博客,架构师,思考,读书,笔记,技术,分享,云">
<meta name=author content="Etaon">
<meta property="og:title" content="Azure-Helm Lab">
<meta property="og:site_name" content="路无止境！">
<meta property="og:image" content="/img/author.jpg">
<meta name=title content="Azure-Helm Lab - 路无止境！">
<meta name=description content="欢迎来到ETAON空间站，个人主要专注于Infra系统架构，私有/公有云产品，售前及微服务解决方案。">
<link rel="shortcut icon" href=/img/favicon.ico>
<link rel=apple-touch-icon href=/img/apple-touch-icon.png>
<link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png>
<link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css>
<link href=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css rel=stylesheet>
<link href=/css/main.css rel=stylesheet type=text/css>
<link href=/css/syntax.css rel=stylesheet type=text/css>
</head>
<body itemscope itemtype=http://schema.org/WebPage lang=zh-hans>
<div class="container one-collumn sidebar-position-left page-home">
<div class=headband></div>
<header id=header class=header itemscope itemtype=http://schema.org/WPHeader>
<div class=header-inner> <div class=site-brand-container>
<div class=site-nav-toggle>
<div class=toggle role=button style=opacity:1;top:0>
<span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span>
</div>
</div>
<div class=site-meta>
<div class=multi-lang-switch>
<i class="fa fa-fw fa-language" style=margin-right:5px></i>
<a class=lang-link id=zh-cn href=#>中文</a>
</div>
<div class=custom-logo-site-title>
<a href=/ class=brand rel=start>
<span class=logo-line-before><i></i></span>
<span class=site-title>路无止境！</span>
<span class=logo-line-after><i></i></span>
</a>
</div>
<p class=site-subtitle>没有伞的孩子要学会努力奔跑!</p>
</div>
<div class=site-nav-right>
<div class="toggle popup-trigger" style=opacity:1;top:0>
<i class="fa fa-search fa-fw fa-lg"></i>
</div>
</div>
</div>
<nav class=site-nav>
<ul id=menu class=menu>
<li class=menu-item>
<a href=/ rel=section>
<i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页
</a>
</li>
<li class=menu-item>
<a href=/post rel=section>
<i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档
</a>
</li>
<li class=menu-item>
<a href=/about.html rel=section>
<i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于我
</a>
</li>
<li class=menu-item>
<a href=/404.html rel=section>
<i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益404
</a>
</li>
<li class="menu-item menu-item-search">
<a href=javascript:; class=popup-trigger> <i class="menu-item-icon fa fa-search fa-fw"></i> <br> 搜索</a>
</li>
</ul>
<div class=site-search>
<div class="popup search-popup local-search-popup">
<div class="local-search-header clearfix">
<span class=search-icon><i class="fa fa-search"></i> </span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span>
<div class=local-search-input-wrapper>
<input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off>
</div>
</div>
<div id=local-search-result></div>
</div>
</div>
</nav>
</div>
</header>
<main id=main class=main>
<div class=main-inner>
<div class=content-wrap>
<div id=content class=content>
<section id=posts class=posts-expand>
<article class="post post-type-normal" itemscope itemtype=http://schema.org/Article>
<header class=post-header>
<h1 class=post-title itemprop="name headline" style=font-weight:700>
<a class=post-title-link href=https://www.etaon.link/2021/12/10/azure-helm.html itemprop=url>
Azure-Helm Lab
</a>
</h1>
</header>
<div class=post-body itemprop=articleBody>
<p><a href=https://helm.sh/zh/docs/>官方文档首页</a></p>
<h2 id=概述>概述</h2>
<p>任何应用程序的部署、版本控制和更新通常都需要规划和管理，以确保部署正确版本的软件库和配置设置，使部署的应用程序能够正常运行。</p>
<p><img src="https://img-blog.csdnimg.cn/06945bd1eae0484fb289975944ebe8a0.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<p>Helm 是 Kubernetes 的包管理器，它将应用程序的所有资源和部署信息组合到单个部署包中。</p>
<p><img src="https://img-blog.csdnimg.cn/0750b85704a7495b93fc6c11dfb89688.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<p>Helm 使用四个组件来管理 Kubernetes 群集上的应用程序部署。</p>
<ul>
<li>Helm 客户端</li>
<li>Helm chart</li>
<li>Helm release</li>
<li>Helm 仓库 <em>repositories</em>，或者叫 <em>repos</em></li>
</ul>
<h3 id=helm-客户端>Helm 客户端</h3>
<p>Helm 客户端是客户端安装的二进制文件，负责创建和提交部署 Kubernetes 应用程序所需的清单文件。 客户端负责用户与 Kubernetes 群集之间的交互。</p>
<p>Helm 客户端适用于所有主要操作系统，安装在客户端电脑上。</p>
<p><img src="https://img-blog.csdnimg.cn/d7a0c1a7644441e9b042255f1eee0e34.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<p>官方安装文档：</p>
<p><a href=https://helm.sh/zh/docs/intro/install/>安装Helm</a></p>
<h3 id=chart><strong>Chart</strong></h3>
<p>描述相关的一组 Kubernetes 资源的模板化部署包。 它包含为了让应用程序在 Kubernetes 群集上运行而为其生成和部署清单文件所需的所有信息。</p>
<p>Charts包含<code>Chart.yaml</code>文件和模板，默认值(<code>values.yaml</code>)，以及相关依赖。</p>
<table>
<thead>
<tr>
<th>文件/文件夹</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chart.yaml</td>
<td>一个 YAML 文件，其中包含有关chart的信息。</td>
</tr>
<tr>
<td>values.yaml</td>
<td>chart的默认配置值。</td>
</tr>
<tr>
<td>templates/</td>
<td>包含chart的部署模板的文件夹。</td>
</tr>
<tr>
<td>LICENSE</td>
<td>包含chart许可证的纯文本文件。</td>
</tr>
<tr>
<td>README.md</td>
<td>一个 Markdown 文件，其中包含有关如何使用chart的说明。</td>
</tr>
<tr>
<td>values.schema.json**</td>
<td>一个架构文件，用于在 values.yaml 文件上应用结构。</td>
</tr>
<tr>
<td>charts/</td>
<td>一个文件夹，其中包含主chart的所有子chart。</td>
</tr>
<tr>
<td>crds/</td>
<td>自定义资源定义。</td>
</tr>
<tr>
<td>templates/Notes.txt</td>
<td>包含模板用法说明的文本文件</td>
</tr>
</tbody>
</table>
<p>Charts开发设计了良好定义的目录结构，并且打包成了一种称为 <em>chart archive</em> 文件格式。</p>
<h4 id=chart包><strong>Chart包</strong></h4>
<p>Chart包(<em>chart archive</em>)是被tar和gzip压缩(并且可选签名)的chart.</p>
<h4 id=chart依赖-子chart><strong>Chart依赖 (子chart)</strong></h4>
<p>Chart可以依赖于其他的chart。 依赖可能会以以下两种方式出现:</p>
<ul>
<li>软依赖： 如果另一个chart没有在集群中安装，chart可能会无法使用。Helm未对这个案例提供工具。 这个案例中，依赖会被分别管理。</li>
<li>硬依赖： 一个chart可以包含 (在它的<code>charts/</code>目录中) 另一个它所依赖的chart。这个案例中， 安装chart的同时会安装所有依赖。chart和它的依赖会作为一个集合进行管理。</li>
</ul>
<p>当一个chart(通过<code>helm package</code>)打包时所有的依赖都会和它绑定。</p>
<h3 id=release>R<strong>elease</strong></h3>
<p>Chart版本根据 <a href=https://semver.org/>语义化版本2.0 细则</a> 发布。</p>
<p>Helm release是使用chart部署的应用程序或应用程序组。 每次安装chart时，都会在群集上创建应用程序的新实例。 每个实例都有一个release名称，可用于与特定的应用程序实例进行交互，Helm库会利用<em>release</em> 来跟踪这个安装。</p>
<p><img src="https://img-blog.csdnimg.cn/c4bd0fa3b0874298b50ed6e52c74ea90.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<h4 id=版本号><strong>版本号</strong></h4>
<p>单个版本号可以被升级多次。通过连续技术来跟踪升级发布版本。在第一次<code>helm install</code>之后，一个版本 会有 <em>release number</em> 1，每一次版本升级或回滚，版本号都会升级。</p>
<h4 id=回滚><strong>回滚</strong></h4>
<p>每一次发布会更新chart或者配置。当生成发布历史后，一次发布也可以被 <em>rolled back</em> 之前的发布版本号。 回滚使用 <code>helm rollback</code> 命令实现。</p>
<p><strong>重要： 每一次回滚版本会生成一个新的发布版本号。</strong></p>
<p>例：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>版本号</th>
</tr>
</thead>
<tbody>
<tr>
<td>install</td>
<td>release 1</td>
</tr>
<tr>
<td>upgrade</td>
<td>release 2</td>
</tr>
<tr>
<td>upgrade</td>
<td>release 3</td>
</tr>
<tr>
<td>rollback 1</td>
<td>release 4 (但使用release 1的配置)</td>
</tr>
</tbody>
</table>
<h4 id=values-values文件-valuesyaml><strong>Values (Values文件, values.yaml)</strong></h4>
<p>Values 提供了一种使用用户自己的信息覆盖模板默认值的方式。</p>
<p>Helm Chart是"参数化的", 这意味着chart开发者可以在安装时显式配置。比如说，chart可以暴露<code>username</code>字段， 允许为服务设置一个用户名。</p>
<p>这些可暴露的变量在Helm用语中称为 <em>values</em>。</p>
<p>Values可以在 <code>helm install</code>时和<code>helm upgrade</code>时设置，直接把它们传值进来，也可以使用<code>values.yaml</code>文件设置。</p>
<h3 id=helm-仓库存储库>Helm 仓库/存储库</h3>
<p>Helm chart可以被存储在专用的HTTP服务器上，称之为 <em>chart 仓库</em>（<em>repositories</em>，或者就叫 <em>repos</em>）。</p>
<p>chart仓库服务器就是一个简单的HTTP服务器，提供一个<code>index.yaml</code> 文件来描述一批chart， 并且提供每个chart的下载位置信息。(很多chart仓库同时提供chart和 <code>index.yaml</code>文件。)</p>
<p><img src="https://img-blog.csdnimg.cn/ce89025246094b9c836de9be85e0963c.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<p>Helm 项目承载了许多公共chart，并且存在你可以从中重复使用chart的许多存储库。</p>
<p>Helm客户端可以指向0个或多个chart仓库。默认没有配置仓库。Chart仓库可以随时使用<code>helm repo add</code>命令添加。</p>
<h2 id=helm-如何处理chart><strong>Helm 如何处理chart</strong></h2>
<p>Helm 客户端实现了一个基于 Go 语言的模板引擎，用于分析某个chart的文件夹中所有可用的文件。 模板引擎通过将chart的 <code>templates/</code> 文件夹中的模板与 <code>Chart.yaml</code> 和 <code>values.yaml</code> 文件中的值组合使用来创建 Kubernetes 清单文件。</p>
<p><img src="https://img-blog.csdnimg.cn/85937b78e8b343d6b4b877354e92f489.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARXRhb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=在这里插入图片描述></p>
<p>在清单文件可用后，客户端可以安装、升级和删除在生成的清单文件中定义的应用程序。</p>
<h3 id=定义-chartyaml-文件><strong>定义 Chart.yaml 文件</strong></h3>
<p><code>Chart.yaml</code> 是 Helm chart定义中所需的文件之一，它提供有关chart的信息。 该文件的内容包括三个必填字段和各种可选字段。</p>
<p>三个必填字段为：</p>
<ul>
<li><code>apiVersion</code> 此值是要使用的chart API 版本。 对于使用 Helm 3 的chart，请将版本设置为 <code>v2</code>。</li>
<li>chart的 <code>name</code>。</li>
<li>chart的 <code>version</code>。 版本号使用语义版本控制 2.0.0，并遵循 <code>MAJOR.MINOR.PATCH</code> 版本号表示法。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v2<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>A Helm chart for Kubernetes<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># A chart can be either an &#39;application&#39; or a &#39;library&#39; chart.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Application charts are a collection of templates that can be packaged into versioned archives</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># to be deployed.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Library charts provide useful utilities or functions for the chart developer. They&#39;re included as</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># a dependency of application charts to inject those utilities and functions into the rendering</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>application<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># This is the chart version. This version number should be incremented each time you make changes</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># to the chart and its templates, including the app version.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Versions are expected to follow Semantic Versioning (https://semver.org/)</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#666>0.1.0</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># This is the version number of the application being deployed. This version number should be</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># incremented each time you make changes to the application. Versions are not expected to</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># follow Semantic Versioning. They should reflect the version the application is using.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># It is recommended to use it with quotes.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>appVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1.16.0&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>上面的 <code>type</code> 字段可以创建chart来安装应用程序或库。 默认chart类型为 <code>application</code>，可将其设置为 <code>library</code> 以指定chart 来安装库。</p>
<p>许多可选字段可用来定制chart部署过程。 例如，你可以使用 <code>dependencies</code> 字段指定chart的其他要求。 例如，依赖于数据库的 Web 应用。</p>
<h3 id=定义chart模板><strong>定义chart模板</strong></h3>
<p>Helm chart模板是描述不同部署类型清单文件的文件。 chart模板以 Go 模板语言编写，提供了用于自动创建 Kubernetes 对象清单文件的其他模板函数。</p>
<p>模板文件存储在chart的 <code>templates/</code> 文件夹中，由模板引擎进行处理以创建最终的对象清单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@master01:~/nginx# ll templates/
total <span style=color:#666>40</span>
drwxr-xr-x <span style=color:#666>3</span> root root <span style=color:#666>4096</span> Dec  <span style=color:#666>9</span> 04:11 ./
drwxr-xr-x <span style=color:#666>4</span> root root <span style=color:#666>4096</span> Dec <span style=color:#666>10</span> 02:20 ../
-rw-r--r-- <span style=color:#666>1</span> root root <span style=color:#666>1826</span> Dec  <span style=color:#666>9</span> 04:07 deployment.yaml
-rw-r--r-- <span style=color:#666>1</span> root root <span style=color:#666>1762</span> Dec  <span style=color:#666>9</span> 04:07 _helpers.tpl
-rw-r--r-- <span style=color:#666>1</span> root root  <span style=color:#666>910</span> Dec  <span style=color:#666>9</span> 04:07 hpa.yaml
-rw-r--r-- <span style=color:#666>1</span> root root <span style=color:#666>2075</span> Dec  <span style=color:#666>9</span> 04:07 ingress.yaml
-rw-r--r-- <span style=color:#666>1</span> root root <span style=color:#666>1739</span> Dec  <span style=color:#666>9</span> 04:07 NOTES.txt
-rw-r--r-- <span style=color:#666>1</span> root root  <span style=color:#666>316</span> Dec  <span style=color:#666>9</span> 04:07 serviceaccount.yaml
-rw-r--r-- <span style=color:#666>1</span> root root  <span style=color:#666>355</span> Dec  <span style=color:#666>9</span> 04:07 service.yaml
drwxr-xr-x <span style=color:#666>2</span> root root <span style=color:#666>4096</span> Dec  <span style=color:#666>9</span> 04:07 tests/
</code></pre></div><p>以deployment.yaml为例</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#bbb>
</span><span style=color:#bbb></span>root@master01:~/nginx# cat templates/deployment.yaml<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;nginx.fullname&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>{{- include &#34;nginx.labels&#34; . | nindent 4 }}<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>{{- if not .Values.autoscaling.enabled }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.replicaCount }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- include &#34;nginx.selectorLabels&#34; . | nindent 6 }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- with .Values.podAnnotations }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- include &#34;nginx.selectorLabels&#34; . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- with .Values.imagePullSecrets }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>imagePullSecrets</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;nginx.serviceAccountName&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml .Values.podSecurityContext | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Chart.Name }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>{{- toYaml .Values.securityContext | nindent 12 }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.image.pullPolicy }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>{{- toYaml .Values.resources | nindent 12 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- with .Values.nodeSelector }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- with .Values.affinity }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>affinity</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- with .Values.tolerations }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- toYaml . | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span></code></pre></div><p>Helm chart允许定义包含值占位符的清单模板，以避免对值进行硬编码。</p>
<p>注意 <code>{{.Values.&lt;property>}}</code> 语法的使用。 此语法允许为每个自定义值创建占位符。</p>
<p>可以通过传递值参数或修改 <code>values.yaml</code> 文件来替代 Helm chart的值。</p>
<p>如：上面定义的：replicas: {{ .Values.replicaCount }}，在使用 <code>--set</code> 参数的情况下运行 <code>helm install</code>，将部署模板的 <code>replicaCount</code> 设置为五个副本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>helm install --set replicaCount=5 webapp bitnami/nginx
</code></pre></div><p>手动创建 Helm chart的过程很繁琐。 创建 Helm chart的一种简单方法是使用 <code>helm create</code> 命令创建新的 Helm chart。 然后，根据你的应用程序的要求自定义自动生成的文件。</p>
<h3 id=定义-valuesyaml-文件><strong>定义 values.yaml 文件</strong></h3>
<p>使用chart值自定义 Helm chart的配置。 在部署chart时，chart值可以是预定义的，也可以由用户提供。</p>
<p><strong>预定义的</strong> 值是一个区分大小写的值，它是在 Helm chart的上下文中预定义的，不能由用户更改。 例如，可以使用 <code>Release.Name</code> 来引用发布或 <code>Release.IsInstall</code> 的名称，以检查当前操作是否是一个安装。可以使用预定义的值从 <code>Chart.yaml</code> 的内容中提取数据。 例如，如果想要检查chart的版本，则引用 <code>Chart.Version</code>。
记住，只能引用已知字段。 可以将预定义的值视为常量，以在创建的模板中使用它们。</p>
<p>在模板文件中包含值名称的语法是通过将值名称括在双大括号中来完成的，例如 <code>{{.Release.Name}}</code>。 请注意，值名称前使用了句点。 以此方式使用句点时，句点将充当查找运算符，并指示该变量的当前作用域。</p>
<p>例如，下面的 YAML 代码段包含在值文件中定义的字典。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>object</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>value<span style=color:#bbb>
</span><span style=color:#bbb>
</span></code></pre></div><p>若要访问模板中的值，可以使用以下语法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>{{<span style=color:#bbb> </span>.Values.object.key }}<span style=color:#bbb>
</span></code></pre></div><p>在上面的deployment.yaml的例子中</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.image.pullPolicy }}<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># root@master01:~/nginx# cat values.yaml</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Default values for nginx.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># This is a YAML-formatted file.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Declare variables to be passed into your templates.</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>replicaCount</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span>v19.3<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>pullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></code></pre></div><p>在模板引擎应用值后，最终结果将如以下示例所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:v19.3<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div><p>验来自于<a href=https://docs.microsoft.com/zh-cn/learn/modules/aks-app-package-management-using-helm/>使用 Helm 管理应用程序和包</a></p>
<h2 id=实验环境>实验环境</h2>
<p>在此实验中，将使用 HELM 为测试部署安装一个 AKS 群集。 使用脚本来创建和配置 Azure Kubernetes 服务 (AKS) 群集。</p>
<p>此脚本执行以下配置步骤：</p>
<ul>
<li>选择要与此模块的练习一起使用的订阅，并将其设置为所有已部署资源的默认订阅。</li>
<li>使用 Azure CLI 创建 Azure Kubernetes 服务群集。</li>
<li>配置默认的 Kubernetes NGINX 入口控制器和负载均衡器。</li>
<li>从 GitHub 存储库克隆示例Web 应用和 Helm chart。</li>
<li>在/home/<em>user</em>/clouddrive/mslearn-aks/create-aks-exports.txt
中捕获所有配置值，以方便引用。</li>
</ul>
<h3 id=运行部署脚本>运行部署脚本</h3>
<ol>
<li>使用 bash 部署脚本，该脚本使用以下参数部署新群集：</li>
</ol>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>-s</td>
<td>标识要使用的订阅 ID。</td>
</tr>
<tr>
<td>-n</td>
<td>标识用于在此模块的上下文中创建群集的 AKS 群集名称和资源组。</td>
</tr>
<tr>
<td>&ndash;use-acr</td>
<td>允许脚本配置名为 mslearn-kubernetes-acr 的默认 ACR。 默认值为 false。</td>
</tr>
<tr>
<td>&ndash;install-dot-net</td>
<td>允许脚本安装 .NET Core SDK。 默认值设置为 false。</td>
</tr>
</tbody>
</table>
<p>脚本地址：<a href=https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/setup.sh>https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/setup.sh</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#080>#!/bin/bash
</span><span style=color:#080></span>
<span style=color:#080;font-style:italic># Hi!</span>
<span style=color:#080;font-style:italic># If you&#39;re reading this, you&#39;re probably interested in what&#39;s going on within this script.</span>
<span style=color:#080;font-style:italic># We&#39;ve provided what we hope are useful comments inline, as well as color-coded relevant</span>
<span style=color:#080;font-style:italic># shell output. We hope it&#39;s useful for you, but if you have any questions or suggestions</span>
<span style=color:#080;font-style:italic># please open an issue on https:/github.com/MicrosoftDocs/mslearn-aks.</span>

<span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>[</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$1</span><span style=color:#b44>&#34;</span> !<span style=color:#666>=</span> <span style=color:#b44>&#34;&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>do</span>
    <span style=color:#a2f;font-weight:700>case</span> <span style=color:#b8860b>$1</span> in
        -s | --subscription<span style=color:#666>)</span>            <span style=color:#a2f>shift</span>
                                        <span style=color:#b8860b>clusterSubs</span><span style=color:#666>=</span><span style=color:#b8860b>$1</span>
                                        ;;
        -n | --name<span style=color:#666>)</span>                    <span style=color:#a2f>shift</span>
                                        <span style=color:#b8860b>moduleName</span><span style=color:#666>=</span><span style=color:#b8860b>$1</span>
                                        ;;
        -a | --use-acr<span style=color:#666>)</span>                 <span style=color:#a2f>shift</span>
                                        <span style=color:#b8860b>useACR</span><span style=color:#666>=</span><span style=color:#b8860b>$1</span>
                                        ;;
        -i | --install-dot-net<span style=color:#666>)</span>         <span style=color:#a2f>shift</span>
                                        <span style=color:#b8860b>installDotNet</span><span style=color:#666>=</span><span style=color:#b8860b>$1</span>
                                        ;;
             * <span style=color:#666>)</span>                        <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Invalid param: </span><span style=color:#b8860b>$1</span><span style=color:#b44>&#34;</span>
                                        <span style=color:#a2f>exit</span> <span style=color:#666>1</span>
    <span style=color:#a2f;font-weight:700>esac</span>
    <span style=color:#a2f>shift</span>
<span style=color:#a2f;font-weight:700>done</span>

<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$clusterSubs</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
     <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}${</span><span style=color:#b8860b>errorStyle</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>ERROR: Subscription is mandatory. Use -s to set it.</span><span style=color:#b8860b>$clusterSubs</span><span style=color:#b44>.</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>defaultTextStyle</span><span style=color:#b68;font-weight:700>}${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>
     <span style=color:#b8860b>listSubsCommand</span><span style=color:#666>=</span><span style=color:#b44>&#34;az account list -o table&#34;</span>
     <span style=color:#b8860b>$listSubsCommand</span>
     <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>Use one of the </span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>azCliCommandStyle</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>SubscriptionId</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>defaultTextStyle</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44> above to run the command</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>
     <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>1</span>
<span style=color:#a2f;font-weight:700>fi</span>

<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$moduleName</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
     <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}${</span><span style=color:#b8860b>errorStyle</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>ERROR: Cluster name is mandatory. Use -n to set it.</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>defaultTextStyle</span><span style=color:#b68;font-weight:700>}${</span><span style=color:#b8860b>newline</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>
     <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>1</span>
<span style=color:#a2f;font-weight:700>fi</span>

<span style=color:#080;font-style:italic>## Start</span>
<span style=color:#a2f>cd</span> ~

<span style=color:#080;font-style:italic># dotnet SDK version</span>
<span style=color:#a2f>declare</span> -x <span style=color:#b8860b>dotnetSdkVersion</span><span style=color:#666>=</span><span style=color:#b44>&#34;3.1.302&#34;</span>

<span style=color:#080;font-style:italic># Module name</span>
<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$moduleName</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
    <span style=color:#a2f>declare</span> <span style=color:#b8860b>moduleName</span><span style=color:#666>=</span><span style=color:#b44>&#34;mslearn-aks&#34;</span>
<span style=color:#a2f;font-weight:700>fi</span>

<span style=color:#080;font-style:italic># Any other declarations we need</span>
<span style=color:#a2f>declare</span> -x <span style=color:#b8860b>gitUser</span><span style=color:#666>=</span><span style=color:#b44>&#34;MicrosoftDocs&#34;</span>
<span style=color:#a2f>declare</span> -x <span style=color:#b8860b>gitBranch</span><span style=color:#666>=</span><span style=color:#b44>&#34;main&#34;</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>initScript</span><span style=color:#666>=</span>https://raw.githubusercontent.com/<span style=color:#b8860b>$gitUser</span>/mslearn-aks/<span style=color:#b8860b>$gitBranch</span>/infrastructure/setup/init-env.sh
<span style=color:#a2f>declare</span> <span style=color:#b8860b>suppressAzureResources</span><span style=color:#666>=</span><span style=color:#a2f>false</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>rootLocation</span><span style=color:#666>=</span>~/clouddrive
<span style=color:#a2f>declare</span> <span style=color:#b8860b>editorHomeLocation</span><span style=color:#666>=</span><span style=color:#b8860b>$rootLocation</span>/mslearn-aks

<span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -d <span style=color:#b44>&#34;</span><span style=color:#b8860b>$rootLocation</span><span style=color:#b44>/mslearn-aks&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$rootLocation</span><span style=color:#b44>/mslearn-aks/ already exists!&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34; &#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Before running this script, please remove or rename the existing </span><span style=color:#b8860b>$rootLocation</span><span style=color:#b44>/mslearn-aks/ directory as follows:&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Remove: rm -r </span><span style=color:#b8860b>$rootLocation</span><span style=color:#b44>/mslearn-aks/&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Rename: mv </span><span style=color:#b8860b>$rootLocation</span><span style=color:#b44>/mslearn-aks/ ~/clouddrive/new-name-here/&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34; &#34;</span>
    <span style=color:#a2f;font-weight:700>return</span> <span style=color:#666>1</span>
<span style=color:#a2f;font-weight:700>else</span>
    <span style=color:#080;font-style:italic># Backup .bashrc</span>
    cp ~/.bashrc ~/.bashrc.bak.<span style=color:#b8860b>$moduleName</span>

    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$installDotNet</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
        <span style=color:#a2f>declare</span> <span style=color:#b8860b>installDotNet</span><span style=color:#666>=</span><span style=color:#b44>&#34;false&#34;</span>
    <span style=color:#a2f;font-weight:700>fi</span>

    <span style=color:#080;font-style:italic># Grab and run init-env.sh</span>
    . &lt;<span style=color:#666>(</span>wget -q -O - <span style=color:#b8860b>$initScript</span><span style=color:#666>)</span>

    <span style=color:#080;font-style:italic># Download and build</span>
    downloadAndBuild

    <span style=color:#080;font-style:italic># Set location to ~/clouddrive</span>
    <span style=color:#a2f>cd</span> <span style=color:#b8860b>$editorHomeLocation</span>

    <span style=color:#080;font-style:italic># Run mslearn-aks quickstart to deploy to AKS</span>
    <span style=color:#b8860b>$editorHomeLocation</span>/infrastructure/deploy/k8s/quickstart.sh --subscription <span style=color:#b8860b>$clusterSubs</span> --resource-group <span style=color:#b8860b>$resourceGroupName</span> -n <span style=color:#b8860b>$moduleName</span> --location westus

    <span style=color:#080;font-style:italic># Create ACR resource</span>
    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$useACR</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
        <span style=color:#a2f>declare</span> <span style=color:#b8860b>useACR</span><span style=color:#666>=</span><span style=color:#b44>&#34;false&#34;</span>
    <span style=color:#a2f;font-weight:700>fi</span>

    <span style=color:#a2f;font-weight:700>if</span>  ! <span style=color:#666>[</span> -z <span style=color:#b44>&#34;</span><span style=color:#b8860b>$useACR</span><span style=color:#b44>&#34;</span> <span style=color:#666>]</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>[</span> <span style=color:#b8860b>$useACR</span> <span style=color:#666>==</span> <span style=color:#a2f>true</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>then</span>
        <span style=color:#b8860b>$editorHomeLocation</span>/infrastructure/deploy/k8s/create-acr.sh --subscription <span style=color:#b8860b>$clusterSubs</span> --resource-group <span style=color:#b8860b>$resourceGroupName</span> --aks-name <span style=color:#b8860b>$moduleName</span> --acr-name mslearn-aks-acr --location westus
    <span style=color:#a2f;font-weight:700>fi</span>

    <span style=color:#080;font-style:italic># Display information to use</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Azure Container Registry Information&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;==================================================================================&#34;</span>
    cat ~/clouddrive/mslearn-aks/create-acr-exports.txt
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;==================================================================================&#34;</span>
    <span style=color:#a2f>echo</span>
    <span style=color:#a2f>echo</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;Azure Container Kubernetes Cluster Information&#34;</span>
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;==================================================================================&#34;</span>
    cat ~/clouddrive/mslearn-aks/create-aks-exports.txt
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;==================================================================================&#34;</span>
<span style=color:#a2f;font-weight:700>fi</span>

<span style=color:#080;font-style:italic>#Reset variables</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>clusterSubs</span><span style=color:#666>=</span><span style=color:#b44>&#34;&#34;</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>moduleName</span><span style=color:#666>=</span><span style=color:#b44>&#34;&#34;</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>useACR</span><span style=color:#666>=</span><span style=color:#b44>&#34;false&#34;</span>
<span style=color:#a2f>declare</span> <span style=color:#b8860b>installDotNet</span><span style=color:#666>=</span><span style=color:#b44>&#34;false&#34;</span>
</code></pre></div><ol start=2>
<li>在 Azure Cloud Shell 中运行以下命令以安装运行环境。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>SubscriptionId</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>az account list --query <span style=color:#b44>&#39;[0].id&#39;</span> -o tsv<span style=color:#a2f;font-weight:700>)</span>
. &lt;<span style=color:#666>(</span>wget -q -O - https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/setup.sh <span style=color:#666>)</span> -s <span style=color:#b8860b>$SubscriptionId</span> -n learn-helm-deploy-aks --use-acr <span style=color:#a2f>false</span> --install-dot-net <span style=color:#a2f>false</span>
</code></pre></div><p>执行结果</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~$ <span style=color:#b8860b>SubscriptionId</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>az account list --query <span style=color:#b44>&#39;[0].id&#39;</span> -o tsv<span style=color:#a2f;font-weight:700>)</span>
izhao_yiyi@Azure:~$ . &lt;<span style=color:#666>(</span>wget -q -O - https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/setup.sh <span style=color:#666>)</span> -s <span style=color:#b8860b>$SubscriptionId</span> -n learn-helm-deploy-aks --use-acr <span style=color:#a2f>false</span> --install-dot-net <span style=color:#a2f>false</span>
WARNING!!! It appears you aren<span style=color:#b44>&#39;t currently running in a Microsoft Learn sandbox. Any Azure resources provisioned by this script will result in charges to your Azure subscription.
</span><span style=color:#b44>Using Azure resource group learn-helm-deploy-aks-rg.
</span><span style=color:#b44>
</span><span style=color:#b44>Downloading code...
</span><span style=color:#b44>++ wget -q -O - https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/sparsecheckout.sh
</span><span style=color:#b44>++ bash -s infrastructure/deploy/ modules/learn-helm-deploy-aks/src/
</span><span style=color:#b44>Updating origin
</span><span style=color:#b44>remote: Enumerating objects: 302, done.
</span><span style=color:#b44>remote: Counting objects: 100% (168/168), done.
</span><span style=color:#b44>remote: Compressing objects: 100% (157/157), done.
</span><span style=color:#b44>remote: Total 302 (delta 68), reused 20 (delta 3), pack-reused 134
</span><span style=color:#b44>Receiving objects: 100% (302/302), 381.59 KiB | 838.00 KiB/s, done.
</span><span style=color:#b44>Resolving deltas: 100% (90/90), done.
</span><span style=color:#b44>From https://github.com/MicrosoftDocs/mslearn-aks
</span><span style=color:#b44> * [new branch]      main        -&gt; origin/main
</span><span style=color:#b44> * [new branch]      oct-refresh -&gt; origin/oct-refresh
</span><span style=color:#b44> * [new branch]      test        -&gt; origin/test
</span><span style=color:#b44>
</span><span style=color:#b44>Switching to subscription 14adb214-7b29-422a-ac8a-df2af1e51201...
</span><span style=color:#b44>Switching to subscription 14adb214-7b29-422a-ac8a-df2af1e51201...
</span><span style=color:#b44>Creating resource group learn-helm-deploy-aks-rg in location westus...
</span><span style=color:#b44> &gt; az group create -n learn-helm-deploy-aks-rg -l westus --output none
</span><span style=color:#b44>
</span><span style=color:#b44>Creating AKS cluster &#34;learn-helm-deploy-aks&#34; in resource group &#34;learn-helm-deploy-aks-rg&#34; and location &#34;westus&#34;...
</span><span style=color:#b44> &gt; az aks create -n learn-helm-deploy-aks -g learn-helm-deploy-aks-rg --node-count 1 --node-vm-size Standard_B2s --vm-set-type VirtualMachineScaleSets -l westus --enable-managed-identity --generate-ssh-keys -o json
</span><span style=color:#b44>WARNING: The behavior of this command has been altered by the following extension: aks-preview
</span><span style=color:#b44>
</span><span style=color:#b44>AKS cluster created.
</span><span style=color:#b44>
</span><span style=color:#b44>Getting credentials for AKS...
</span><span style=color:#b44>The behavior of this command has been altered by the following extension: aks-preview
</span><span style=color:#b44>Merged &#34;learn-helm-deploy-aks&#34; as current context in /home/izhao_yiyi/.kube/config
</span><span style=color:#b44>
</span><span style=color:#b44>Installing NGINX ingress controller
</span><span style=color:#b44>namespace/nginx-ingress created
</span><span style=color:#b44>serviceaccount/nginx-ingress created
</span><span style=color:#b44>clusterrole.rbac.authorization.k8s.io/nginx-ingress created
</span><span style=color:#b44>clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress created
</span><span style=color:#b44>secret/default-server-secret created
</span><span style=color:#b44>configmap/nginx-config created
</span><span style=color:#b44>ingressclass.networking.k8s.io/nginx created
</span><span style=color:#b44>deployment.apps/nginx-ingress created
</span><span style=color:#b44>service/nginx-ingress created
</span><span style=color:#b44>
</span><span style=color:#b44>Getting load balancer public IP
</span><span style=color:#b44> &gt; az aks list --query &#34;[?name==&#39;</span>learn-helm-deploy-aks<span style=color:#b44>&#39;&amp;&amp;resourceGroup==&#39;</span>learn-helm-deploy-aks-rg<span>&#39;</span><span style=color:#666>]</span>.nodeResourceGroup<span style=color:#b44>&#34; -o tsv
</span><span style=color:#b44>Waiting for the Load Balancer IP address - Ctrl+C to cancel...
</span><span style=color:#b44>Waiting for the Load Balancer IP address - Ctrl+C to cancel...
</span><span style=color:#b44>Waiting for the Load Balancer IP address - Ctrl+C to cancel...
</span><span style=color:#b44>Assigned IP address: 104.42.158.195
</span><span style=color:#b44>
</span><span style=color:#b44>Nginx ingress controller installed.
</span><span style=color:#b44>Azure Container Registry Information
</span><span style=color:#b44>==================================================================================
</span><span style=color:#b44>cat: /home/izhao_yiyi/clouddrive/mslearn-aks/create-acr-exports.txt: No such file or directory
</span><span style=color:#b44>==================================================================================
</span><span style=color:#b44>
</span><span style=color:#b44>
</span><span style=color:#b44>Azure Container Kubernetes Cluster Information
</span><span style=color:#b44>==================================================================================
</span><span style=color:#b44>export CLUSTER_NAME=learn-helm-deploy-aks
</span><span style=color:#b44>export CLUSTER_SUBS=14adb214-7b29-422a-ac8a-df2af1e51201
</span><span style=color:#b44>export CLUSTER_RG=learn-helm-deploy-aks-rg
</span><span style=color:#b44>export CLUSTER_LOCATION=westus
</span><span style=color:#b44>export CLUSTER_AKSNODERG=MC_learn-helm-deploy-aks-rg_learn-helm-deploy-aks_westus
</span><span style=color:#b44>export CLUSTER_LBIP=104.42.158.195
</span><span style=color:#b44>export LEARN_REGISTRY=learn-aks-registry
</span><span style=color:#b44>==================================================================================
</span></code></pre></div><h2 id=安装-helm-chart>安装 Helm chart</h2>
<p>在此实验中，将 Helm 存储库添加到 Helm 客户端，并将 ASP.NET Core 网站安装到 Azure Kubernetes 服务群集。</p>
<h3 id=提取-helm-chart>提取 Helm chart</h3>
<ol>
<li>在 Azure Cloud Shell 中，将 Azure 市场 Helm 存储库添加到 Helm 客户端。 可以通过此存储库访问许多预配置的 Helm chart。</li>
</ol>
<blockquote>
<p>helm repo add azure-marketplace <a href=https://marketplace.azurecr.io/helm/v1/repo>https://marketplace.azurecr.io/helm/v1/repo</a></p>
</blockquote>
<ol start=2>
<li>运行 helm repo list 命令来确认新添加的存储库。</li>
</ol>
<blockquote>
<p>helm repo list</p>
</blockquote>
<p>上述命令返回以下输出的结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm repo add azure-marketplace https://marketplace.azurecr.io/helm/v1/repo
<span style=color:#b44>&#34;azure-marketplace&#34;</span> has been added to your repositories
izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm version
version.BuildInfo<span style=color:#666>{</span>Version:<span style=color:#b44>&#34;v3.4.0&#34;</span>, GitCommit:<span style=color:#b44>&#34;7090a89efc8a18f3d8178bf47d2462450349a004&#34;</span>, GitTreeState:<span style=color:#b44>&#34;clean&#34;</span>, GoVersion:<span style=color:#b44>&#34;go1.14.10&#34;</span><span style=color:#666>}</span>
izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm repo ls
NAME                    URL
azure-marketplace       https://marketplace.azurecr.io/helm/v1/repo
</code></pre></div><ol start=3>
<li>运行 helm search repo 命令，以搜索 azure-marketplace/aspnet-core chart</li>
</ol>
<blockquote>
<p>helm search repo aspnet</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm search repo aspnet
NAME                            CHART VERSION   APP VERSION     DESCRIPTION
azure-marketplace/aspnet-core   2.0.1           3.1.21          ASP.NET Core is an open-source framework create...
</code></pre></div><h3 id=部署-helm-chart>部署 Helm chart</h3>
<ol>
<li>使用 helm install 命令部署 ASP.NET Core Helm chart。</li>
</ol>
<blockquote>
<p>helm install aspnet-webapp azure-marketplace/aspnet-core</p>
</blockquote>
<p>此命令返回以下输出的结果:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm install aspnet-webapp azure-marketplace/aspnet-core
NAME: aspnet-webapp
LAST DEPLOYED: Thu Dec  <span style=color:#666>9</span> 14:31:00 <span style=color:#666>2021</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span style=color:#666>1</span>
TEST SUITE: None
NOTES:
CHART NAME: aspnet-core
CHART VERSION: 2.0.1
APP VERSION: 3.1.21

** Please be patient <span style=color:#a2f;font-weight:700>while</span> the chart is being deployed **

ASP.NET Core can be accessed through the following DNS name from within your cluster:

    aspnet-webapp-aspnet-core.default.svc.cluster.local <span style=color:#666>(</span>port <span style=color:#666>)</span>

To access ASP.NET Core from outside the cluster execute the following commands:

1. Get the ASP.NET Core URL by running these commands:

    <span style=color:#a2f>export</span> <span style=color:#b8860b>SERVICE_PORT</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get --namespace default -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.spec.ports[0].port}&#34;</span> services aspnet-webapp-aspnet-core<span style=color:#a2f;font-weight:700>)</span>
    kubectl port-forward --namespace default svc/aspnet-webapp-aspnet-core <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span>:<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span> &amp;
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;http://127.0.0.1:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>

2. Access ASP.NET Core using the obtained URL.
</code></pre></div><ol start=2>
<li>使用 helm list 命令来列出所有 Helm release。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
aspnet-webapp   default         <span style=color:#666>1</span>               2021-12-09 14:31:00.966036159 +0000 UTC deployed        aspnet-core-2.0.1       3.1.21
</code></pre></div><p>每次对发布进行更改时，修订号version都将递增。</p>
<ol start=3>
<li>Helm 允许使用 helm get manifest 命令提取与每个发布相关的清单信息:</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm get manifest aspnet-webapp
---
<span style=color:#080;font-style:italic># Source: aspnet-core/templates/serviceaccount.yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aspnet-webapp-aspnet-core
  labels:
    app.kubernetes.io/name: aspnet-core
    helm.sh/chart: aspnet-core-2.0.1
    app.kubernetes.io/instance: aspnet-webapp
    app.kubernetes.io/managed-by: Helm
  annotations:
---
<span style=color:#080;font-style:italic># Source: aspnet-core/templates/svc.yaml</span>
apiVersion: v1
kind: Service
metadata:
  name: aspnet-webapp-aspnet-core
  labels:
    app.kubernetes.io/name: aspnet-core
    helm.sh/chart: aspnet-core-2.0.1
    app.kubernetes.io/instance: aspnet-webapp
    app.kubernetes.io/managed-by: Helm
  annotations:
spec:
  type: ClusterIP
  ports:
    - name: http
      port: <span style=color:#666>80</span>
      targetPort: http
      nodePort: null
  selector:
    app.kubernetes.io/name: aspnet-core
    app.kubernetes.io/instance: aspnet-webapp
---
<span style=color:#080;font-style:italic># Source: aspnet-core/templates/deployment.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aspnet-webapp-aspnet-core
  labels:
    app.kubernetes.io/name: aspnet-core
    helm.sh/chart: aspnet-core-2.0.1
    app.kubernetes.io/instance: aspnet-webapp
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: <span style=color:#666>1</span>
  selector:
    matchLabels:
      app.kubernetes.io/name: aspnet-core
      app.kubernetes.io/instance: aspnet-webapp
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aspnet-core
        helm.sh/chart: aspnet-core-2.0.1
        app.kubernetes.io/instance: aspnet-webapp
        app.kubernetes.io/managed-by: Helm
    spec:

      automountServiceAccountToken: <span style=color:#a2f>true</span>
      serviceAccountName: aspnet-webapp-aspnet-core
      affinity:
        podAffinity:

        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: aspnet-core
                    app.kubernetes.io/instance: aspnet-webapp
                namespaces:
                  - <span style=color:#b44>&#34;default&#34;</span>
                topologyKey: kubernetes.io/hostname
              weight: <span style=color:#666>1</span>
        nodeAffinity:

      initContainers:
        - name: clone-repository
          image: marketplace.azurecr.io/bitnami/git:2.33.0-debian-10-r81
          imagePullPolicy: <span style=color:#b44>&#34;IfNotPresent&#34;</span>
          command:
            - /bin/bash
            - -ec
            - |
              <span style=color:#666>[[</span> -f <span style=color:#b44>&#34;/opt/bitnami/scripts/git/entrypoint.sh&#34;</span> <span style=color:#666>]]</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>source</span> <span style=color:#b44>&#34;/opt/bitnami/scripts/git/entrypoint.sh&#34;</span>
              git clone https://github.com/dotnet/AspNetCore.Docs.git --branch main /repo
          volumeMounts:
            - name: repo
              mountPath: /repo
        - name: dotnet-publish
          image: marketplace.azurecr.io/bitnami/dotnet-sdk:3.1.414-debian-10-r26
          imagePullPolicy: <span style=color:#b44>&#34;IfNotPresent&#34;</span>
          workingDir: /repo
          command:
            - /bin/bash
            - -ec
            - |
              <span style=color:#a2f>cd</span> aspnetcore/fundamentals/servers/kestrel/samples/3.x/KestrelSample
              dotnet publish -o /app
          volumeMounts:
            - name: app
              mountPath: /app
            - name: repo
              mountPath: /repo
      containers:
        - name: aspnet-core
          image: marketplace.azurecr.io/bitnami/aspnet-core:3.1.21-debian-10-r0
          imagePullPolicy: <span style=color:#b44>&#34;IfNotPresent&#34;</span>
          workingDir: /app
          command:
            - dotnet
            - KestrelSample.dll
          env:
            - name: ASPNETCORE_URLS
              value: <span style=color:#b44>&#34;http://+:8080&#34;</span>
          ports:
            - name: http
              containerPort: <span style=color:#666>8080</span>
          livenessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: <span style=color:#666>10</span>
            periodSeconds: <span style=color:#666>20</span>
            timeoutSeconds: <span style=color:#666>1</span>
            successThreshold: <span style=color:#666>1</span>
            failureThreshold: <span style=color:#666>6</span>
          readinessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: <span style=color:#666>10</span>
            periodSeconds: <span style=color:#666>20</span>
            timeoutSeconds: <span style=color:#666>1</span>
            successThreshold: <span style=color:#666>1</span>
            failureThreshold: <span style=color:#666>6</span>
          resources:
            limits: <span style=color:#666>{}</span>
            requests: <span style=color:#666>{}</span>
          volumeMounts:
            - name: app
              mountPath: /app
      volumes:
        - name: app
          emptyDir: <span style=color:#666>{}</span>
        - name: repo
          emptyDir: <span style=color:#666>{}</span>
</code></pre></div><p>chart的 templates 文件夹中有三个 YAML 文件。</p>
<ul>
<li>ServiceAccount</li>
<li>服务svc</li>
<li>部署deployment</li>
</ul>
<p>这些文件是根据chart的可用模板和 values.yaml 文件中可用的值的组合呈现的。</p>
<ol start=4>
<li>通过运行/使用 kubectl 命令验证是否已部署 Pod</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ kubectl get all
NAME                                            READY   STATUS    RESTARTS   AGE
pod/aspnet-webapp-aspnet-core-676b9cfdd-xm2ss   1/1     Running   <span style=color:#666>0</span>          3m22s

NAME                                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#666>(</span>S<span style=color:#666>)</span>   AGE
service/aspnet-webapp-aspnet-core   ClusterIP   10.0.116.227   &lt;none&gt;        80/TCP    3m23s
service/kubernetes                  ClusterIP   10.0.0.1       &lt;none&gt;        443/TCP   12m

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/aspnet-webapp-aspnet-core   1/1     <span style=color:#666>1</span>            <span style=color:#666>1</span>           3m23s

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/aspnet-webapp-aspnet-core-676b9cfdd   <span style=color:#666>1</span>         <span style=color:#666>1</span>         <span style=color:#666>1</span>       3m23s
</code></pre></div><ol start=5>
<li>删除 Helm 发布
使用 helm delete 命令删除 Helm 发布</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm delete aspnet-webapp
release <span style=color:#b44>&#34;aspnet-webapp&#34;</span> uninstalled
</code></pre></div><h3 id=使用设置的值安装-helm-chart>使用设置的值安装 Helm chart</h3>
<ol>
<li>可以通过传递值参数或自己的 values.yaml 文件来替代 Helm chart的值。</li>
</ol>
<p>现在，使用 &ndash;set 参数的情况下运行 helm install，将部署模板的 replicaCount 设置为五个副本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm install --set <span style=color:#b8860b>replicaCount</span><span style=color:#666>=</span><span style=color:#666>5</span> aspnet-webapp azure-marketplace/aspnet-core
NAME: aspnet-webapp
LAST DEPLOYED: Thu Dec  <span style=color:#666>9</span> 14:39:09 <span style=color:#666>2021</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span style=color:#666>1</span>
TEST SUITE: None
NOTES:
CHART NAME: aspnet-core
CHART VERSION: 2.0.1
APP VERSION: 3.1.21

** Please be patient <span style=color:#a2f;font-weight:700>while</span> the chart is being deployed **

ASP.NET Core can be accessed through the following DNS name from within your cluster:

    aspnet-webapp-aspnet-core.default.svc.cluster.local <span style=color:#666>(</span>port <span style=color:#666>)</span>

To access ASP.NET Core from outside the cluster execute the following commands:

1. Get the ASP.NET Core URL by running these commands:

    <span style=color:#a2f>export</span> <span style=color:#b8860b>SERVICE_PORT</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get --namespace default -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.spec.ports[0].port}&#34;</span> services aspnet-webapp-aspnet-core<span style=color:#a2f;font-weight:700>)</span>
    kubectl port-forward --namespace default svc/aspnet-webapp-aspnet-core <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span>:<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span> &amp;
    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;http://127.0.0.1:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_PORT</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>

2. Access ASP.NET Core using the obtained URL.
</code></pre></div><p>通过运行 kubectl get pods 命令验证</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ kubectl get po
NAME                                        READY   STATUS    RESTARTS   AGE
aspnet-webapp-aspnet-core-676b9cfdd-7542j   1/1     Running   <span style=color:#666>0</span>          4m11s
aspnet-webapp-aspnet-core-676b9cfdd-bxf9w   1/1     Running   <span style=color:#666>0</span>          4m11s
aspnet-webapp-aspnet-core-676b9cfdd-cm79p   1/1     Running   <span style=color:#666>0</span>          4m11s
aspnet-webapp-aspnet-core-676b9cfdd-pjgl7   1/1     Running   <span style=color:#666>0</span>          4m11s
aspnet-webapp-aspnet-core-676b9cfdd-qg8nd   1/1     Running   <span style=color:#666>0</span>          4m11s
</code></pre></div><p>2.使用 helm delete 命令删除 Helm chart。 此命令将删除工作负荷的发布和所有副本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ helm delete aspnet-webapp
release <span style=color:#b44>&#34;aspnet-webapp&#34;</span> uninstalled
</code></pre></div><h2 id=管理-helm-发布>管理 Helm 发布</h2>
<p>在此练习中，自定义现有的 Helm chart来安装、升级、回滚和删除 Helm 发布。</p>
<h3 id=查看-helm-chart文件夹结构>查看 Helm chart文件夹结构</h3>
<p>之前从 Azure 市场安装的 aspnet-core Helm chart作为基础来安装 .NET Core Blazor Server 应用。 在 AKS 群集创建中已下载了应用程序的源代码，这些源代码位于 ~clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src/drone-webapp 文件夹中。</p>
<ol>
<li>列出 $HOME/.cache/helm/repository 文件夹的内容以查找 aspnet-core-xxx.tgz 文件。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ ls <span style=color:#b8860b>$HOME</span>/.cache/helm/repository -l
total <span style=color:#666>5096</span>
-rw-r--r-- <span style=color:#666>1</span> izhao_yiyi izhao_yiyi   <span style=color:#666>32351</span> Dec  <span style=color:#666>9</span> 14:39 aspnet-core-2.0.1.tgz
-rw-r--r-- <span style=color:#666>1</span> izhao_yiyi izhao_yiyi    <span style=color:#666>1440</span> Dec  <span style=color:#666>9</span> 14:28 azure-marketplace-charts.txt
-rw-r--r-- <span style=color:#666>1</span> izhao_yiyi izhao_yiyi <span style=color:#666>5181359</span> Dec  <span style=color:#666>9</span> 14:28 azure-marketplace-index.yaml
</code></pre></div><p>从存储库安装的所有 Helm chart都缓存在此文件夹中。</p>
<ol start=2>
<li>通过递归列出 drone-webapp-chart 文件夹的所有内容，检查现有的 Helm chart
对于本实验，chart已经解压缩，位于 ~clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src/drone-webapp-chart 文件夹中。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks$ <span style=color:#a2f>cd</span> ~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src
izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ find drone-webapp-chart/ -print
drone-webapp-chart/
drone-webapp-chart/.helmignore
drone-webapp-chart/Chart.yaml
drone-webapp-chart/templates
drone-webapp-chart/templates/deployment.yaml
drone-webapp-chart/templates/extra-list.yaml
drone-webapp-chart/templates/health-ingress.yaml
drone-webapp-chart/templates/hpa.yaml
drone-webapp-chart/templates/ingress.yaml
drone-webapp-chart/templates/NOTES.txt
drone-webapp-chart/templates/pdb.yaml
drone-webapp-chart/templates/service.yaml
drone-webapp-chart/templates/serviceaccount.yaml
drone-webapp-chart/templates/tls-secret.yaml
drone-webapp-chart/templates/_helpers.tpl
drone-webapp-chart/values.yaml
</code></pre></div><p>以下组件为核心：</p>
<ul>
<li>Chart.yaml 文件 (drone-webapp-chart/Chart.yaml)</li>
<li>values.yaml 文件 (drone-webapp-chart/values.yaml)</li>
<li>templates/ 文件夹中的许多模板 (drone-webapp-chart/templates)</li>
</ul>
<ol start=3>
<li>使用内置的 Cloud Shell 编辑器打开 drone-webapp-chart/Chart.yaml 以查看chart的依赖项。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v2<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>appVersion</span>:<span style=color:#bbb> </span><span style=color:#666>0.0.1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>ASP.NET Core is an open-source framework created by Microsoft for building<span style=color:#bbb>
</span><span style=color:#bbb>  </span>cloud-enabled, modern applications.<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>home</span>:<span style=color:#bbb> </span>https://dotnet.microsoft.com/apps/aspnet<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>icon</span>:<span style=color:#bbb> </span>https://bitnami.com/assets/stacks/aspnet-core/img/aspnet-core-stack-220x234.png<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>keywords</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- asp.net<span style=color:#bbb>
</span><span style=color:#bbb></span>- dotnet<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>maintainers</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>email</span>:<span style=color:#bbb> </span>containers@bitnami.com<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Bitnami<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>drone-tracker<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- https://github.com/bitnami/bitnami-docker-aspnet-core<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>category</span>:<span style=color:#bbb> </span>DeveloperTools<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#666>1.3.21</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>dependencies</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>common<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#666>1.10.3</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>https://marketplace.azurecr.io/helm/v1/repo<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tags</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- bitnami-common<span style=color:#bbb>
</span></code></pre></div><ol start=4>
<li>运行 helm dependency build 命令可下载和更新全部的chart依赖项</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm dependency build ./drone-webapp-chart
Hang tight <span style=color:#a2f;font-weight:700>while</span> we grab the latest from your chart repositories...
...Successfully got an update from the <span style=color:#b44>&#34;azure-marketplace&#34;</span> chart repository
Update Complete. ⎈Happy Helming!⎈
Saving <span style=color:#666>1</span> charts
Downloading common from repo https://marketplace.azurecr.io/helm/v1/repo
Deleting outdated charts
</code></pre></div><ol start=5>
<li>查看 drone-webapp-chart 文件夹中的文件，以了解 Helm 下载的内容</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ find drone-webapp-chart/ -print
drone-webapp-chart/
drone-webapp-chart/.helmignore
drone-webapp-chart/Chart.lock
drone-webapp-chart/Chart.yaml
drone-webapp-chart/charts
drone-webapp-chart/charts/common-1.10.3.tgz
drone-webapp-chart/templates
drone-webapp-chart/templates/deployment.yaml
drone-webapp-chart/templates/extra-list.yaml
drone-webapp-chart/templates/health-ingress.yaml
drone-webapp-chart/templates/hpa.yaml
drone-webapp-chart/templates/ingress.yaml
drone-webapp-chart/templates/NOTES.txt
drone-webapp-chart/templates/pdb.yaml
drone-webapp-chart/templates/service.yaml
drone-webapp-chart/templates/serviceaccount.yaml
drone-webapp-chart/templates/tls-secret.yaml
drone-webapp-chart/templates/_helpers.tpl
drone-webapp-chart/values.yaml
</code></pre></div><p>现在，charts/ 文件夹中有一个名为 common 的已更新子chart。 可以提取 common-1.10.3.tgz 包的内容</p>
<h3 id=查看chart-valuesyaml-文件>查看chart values.yaml 文件</h3>
<p>aspnet-core Helm chart具有一组广泛的配置选项，可用于管理云原生 Web 应用的总体部署。 查看 values.yaml 的内容以获取部署概述非常有用。</p>
<p>在 Cloud Shell 编辑器中打开 values.yaml。</p>
<blockquote>
<p>vim ./drone-webapp-chart/values.yaml</p>
</blockquote>
<p>此文件中有许多需要关注的点。 这里查看两个节以及它们如何影响最终的已部署应用。</p>
<p>搜索 image 值以查看哪个图像用于 Web 应用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>registry</span>:<span style=color:#bbb> </span>docker.io<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>bitnami/aspnet-core<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span><span style=color:#666>3.1.21</span>-debian-10-r0<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>pullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div><p>注意 bitnami/aspnet-core Docker 映像。 此映像是应用的基础映像，包含 ASP.NET Core 安装。</p>
<p>搜索 appFromExternalRepo 值。 将使用这些值生成 deployment.yaml 清单文件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:green;font-weight:700>appFromExternalRepo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clone</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>registry</span>:<span style=color:#bbb> </span>docker.io<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>bitnami/git<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span><span style=color:#666>2.33.0</span>-debian-10-r28<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pullSecrets</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>https://github.com/MicrosoftDocs/mslearn-aks.git<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>revision</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>extraVolumeMounts</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>publish</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>registry</span>:<span style=color:#bbb> </span>docker.io<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>repository</span>:<span style=color:#bbb> </span>bitnami/dotnet-sdk<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tag</span>:<span style=color:#bbb> </span><span style=color:#666>3.1.412</span>-debian-10-r33<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pullSecrets</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>subFolder</span>:<span style=color:#bbb> </span>modules/learn-helm-deploy-aks/src/drone-webapp<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>extraFlags</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>startCommand</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;dotnet&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;drone-webapp.dll&#34;</span>]<span style=color:#bbb>
</span></code></pre></div><p>此节指定了要注意的几个项。</p>
<ul>
<li>
<p>bitnami/git 映像</p>
</li>
<li>
<p>bitnami/dotnet-sdk 映像</p>
</li>
<li>
<p>GitHub 存储库 <a href=https://github.com/MicrosoftDocs/mslearn-aks.git>https://github.com/MicrosoftDocs/mslearn-aks.git</a></p>
</li>
<li>
<p>应用源代码存储库子文件夹 modules/learn-helm-deploy-aks/src/drone-webapp</p>
</li>
</ul>
<p>这些值中的每一个都在 templates/deployment.yaml 文件中使用。</p>
<p>接下来，在 values.yaml 文件中搜索 ingress 值。 使用这些值生成 ingress.yaml 清单文件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:green;font-weight:700>ingress</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>pathType</span>:<span style=color:#bbb> </span>ImplementationSpecific<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostname</span>:<span style=color:#bbb> </span>aspnet-core.local<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tls</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>secrets</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span></code></pre></div><p>此允许你配置最终入口文件的许多方面。 对于本实验，只需使用 ingress.enabled 值。</p>
<h3 id=查看-deploymentyaml-和-ingressyaml-模板文件>查看 deployment.yaml 和 ingress.yaml 模板文件</h3>
<p>values.yaml 文件中的值与chart的 templates/ 文件夹中的模板结合使用，以创建最终的清单文件。</p>
<ol>
<li>在 Cloud Shell 编辑器中打开 templates/deployment.yaml。</li>
</ol>
<blockquote>
<p>vim ./drone-webapp-chart/templates/deployment.yaml</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;common.capabilities.deployment.apiVersion&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.replicaCount }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initContainers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- if .Values.appFromExternalRepo.enabled }}<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>clone-repository<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;aspnet-core.git.image&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.appFromExternalRepo.clone.image.pullPolicy | quote }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- /bin/bash<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- -ec<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- |<span style=color:#b44;font-style:italic>
</span><span style=color:#b44;font-style:italic>              [[ -f &#34;/opt/bitnami/scripts/git/entrypoint.sh&#34; ]] &amp;&amp; source &#34;/opt/bitnami/scripts/git/entrypoint.sh&#34;
</span><span style=color:#b44;font-style:italic>              git clone {{ .Values.appFromExternalRepo.clone.repository }} --branch {{ .Values.appFromExternalRepo.clone.revision }} /repo</span><span style=color:#bbb>              
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>repo<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/repo<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dotnet-publish<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;aspnet-core.sdk.image&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>.Values.appFromExternalRepo.publish.image.pullPolicy | quote }}<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>workingDir</span>:<span style=color:#bbb> </span>/repo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- /bin/bash<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- -ec<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- |<span style=color:#b44;font-style:italic>
</span><span style=color:#b44;font-style:italic>              cd {{ .Values.appFromExternalRepo.publish.subFolder }}
</span><span style=color:#b44;font-style:italic>              dotnet publish -o /app {{ .Values.appFromExternalRepo.publish.extraFlags | join &#34; &#34; }}</span><span style=color:#bbb>              
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>app<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/app<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>repo<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/repo<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- if .Values.initContainers }}<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- include &#34;common.tplvalues.render&#34; (dict &#34;value&#34; .Values.initContainers &#34;context&#34; $) | nindent 8 }}<span style=color:#bbb>
</span><span style=color:#bbb>        </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>{{- end }}<span style=color:#bbb>
</span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></code></pre></div><p>注意，此文件具有部署清单的结构，但最终哪些信息进入文件取决于 values.yaml 文件中的值和模板控制流逻辑。</p>
<p>例如，此部署的 spec.replicas 是由 {{ .Values.replicaCount }} 定义的，容器如何初始化取决于 {{- if .Values.appFromExternalRepo.enabled }} 语句中的 .Values.appFromExternalRepo.enabled 值。</p>
<p>然后，本节的其余部分会使用 Git 映像和存储库值来克隆存储库并构建 Web 应用。</p>
<ol start=2>
<li>在 Cloud Shell 编辑器中打开 templates/ingress.yaml。</li>
</ol>
<blockquote>
<p>vim ./drone-webapp-chart/templates/ingress.yaml</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>{{- if .Values.ingress.enabled -}}<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;common.capabilities.ingress.apiVersion&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Ingress<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>{{<span style=color:#bbb> </span>include &#34;aspnet-core.fullname&#34; . }}<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb> </span>{{- include &#34;common.labels.standard&#34; . | nindent 4 }}<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb></span>{{- end }}<span style=color:#bbb>
</span></code></pre></div><p>注意入口清单如何依赖于 {{- if .Values.ingress.enabled -}} 语句。</p>
<h3 id=部署-helm-chart-1>部署 Helm chart</h3>
<p>现在可以部署 Web 应用了。</p>
<ol>
<li>使用 helm install 命令部署 drone-webapp Helm chart。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm install drone-webapp ./drone-webapp-chart
NAME: drone-webapp
LAST DEPLOYED: Thu Dec  <span style=color:#666>9</span> 14:59:26 <span style=color:#666>2021</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span style=color:#666>1</span>
TEST SUITE: None
NOTES:
** Please be patient <span style=color:#a2f;font-weight:700>while</span> the chart is being deployed **

ASP.NET Core can be accessed through the following DNS name from within your cluster:

    drone-webapp-aspnet-core.default.svc.cluster.local <span style=color:#666>(</span>port 80<span style=color:#666>)</span>

To access ASP.NET Core from outside the cluster execute the following commands:

1. Get the ASP.NET Core URL and associate its hostname to your cluster external IP:

   <span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_IP</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>minikube ip<span style=color:#a2f;font-weight:700>)</span> <span style=color:#080;font-style:italic># On Minikube. Use: `kubectl cluster-info` on others K8s clusters</span>
   <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;ASP.NET Core URL: http://aspnet-core.local&#34;</span>
   <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$CLUSTER_IP</span><span style=color:#b44>  aspnet-core.local&#34;</span> | sudo tee -a /etc/hosts

2. Access ASP.NET Core using the obtained URL.
</code></pre></div><p>查看安装过程</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ kubectl get po -w
NAME                                        READY   STATUS     RESTARTS   AGE
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:0/2   <span style=color:#666>0</span>          13s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:ErrImagePull   <span style=color:#666>0</span>          72s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:ImagePullBackOff   <span style=color:#666>0</span>          84s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:0/2                <span style=color:#666>0</span>          94s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:1/2                <span style=color:#666>0</span>          95s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Init:1/2                <span style=color:#666>0</span>          2m20s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     PodInitializing         <span style=color:#666>0</span>          2m28s
drone-webapp-aspnet-core-54894f544b-7j72z   0/1     Running                 <span style=color:#666>0</span>          3m6s
izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ kubectl get po
NAME                                        READY   STATUS    RESTARTS   AGE
drone-webapp-aspnet-core-54894f544b-7j72z   1/1     Running   <span style=color:#666>0</span>          3m25s
</code></pre></div><ol start=3>
<li>在 Web 应用运行后，在浏览器中打开 die 群集的负载均衡器 IP 地址，以查看正在运行的 Web 应用。 列出 create-aks-exports.txt 文件的内容以查找负载均衡器的 IP 地址。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ cat ~/clouddrive/mslearn-aks/create-aks-exports.txt
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_NAME</span><span style=color:#666>=</span>learn-helm-deploy-aks
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_SUBS</span><span style=color:#666>=</span>14adb214-7b29-422a-ac8a-df2af1e51201
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_RG</span><span style=color:#666>=</span>learn-helm-deploy-aks-rg
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_LOCATION</span><span style=color:#666>=</span>westus
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_AKSNODERG</span><span style=color:#666>=</span>MC_learn-helm-deploy-aks-rg_learn-helm-deploy-aks_westus
<span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_LBIP</span><span style=color:#666>=</span>104.42.158.195
<span style=color:#a2f>export</span> <span style=color:#b8860b>LEARN_REGISTRY</span><span style=color:#666>=</span>learn-aks-registry
</code></pre></div><h3 id=升级-helm-发布>升级 Helm 发布</h3>
<p>如果开发团队更新了 Web 应用的源代码。 若要部署新版本，需使用 helm upgrade 命令来创建对应用的最新更改的增量。</p>
<ol>
<li>第一步是使用 helm list 命令列出所有 Helm 部署。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
drone-webapp    default         <span style=color:#666>1</span>               2021-12-09 14:59:26.723136514 +0000 UTC deployed        aspnet-core-1.3.18      0.0.1
</code></pre></div><ol start=2>
<li>运行 helm history 命令，查看有关 drone-webapp 的历史记录信息</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm <span style=color:#a2f>history</span> drone-webapp
REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION
<span style=color:#666>1</span>               Thu Dec  <span style=color:#666>9</span> 14:59:26 <span style=color:#666>2021</span>        deployed        aspnet-core-1.3.18      0.0.1           Install <span style=color:#a2f>complete</span>
</code></pre></div><ol start=3>
<li>打开 Chart.yaml 文件，更新应用程序的版本号。
将 appVersion 编号更新为版本 0.0.2，并运行以下 helm upgrade 命令。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm upgrade drone-webapp ./drone-webapp-chart
Release <span style=color:#b44>&#34;drone-webapp&#34;</span> has been upgraded. Happy Helming!
NAME: drone-webapp
LAST DEPLOYED: Thu Dec  <span style=color:#666>9</span> 15:08:18 <span style=color:#666>2021</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span style=color:#666>2</span>
TEST SUITE: None
NOTES:
** Please be patient <span style=color:#a2f;font-weight:700>while</span> the chart is being deployed **

ASP.NET Core can be accessed through the following DNS name from within your cluster:

    drone-webapp-aspnet-core.default.svc.cluster.local <span style=color:#666>(</span>port 80<span style=color:#666>)</span>

To access ASP.NET Core from outside the cluster execute the following commands:

1. Get the ASP.NET Core URL and associate its hostname to your cluster external IP:

   <span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_IP</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>minikube ip<span style=color:#a2f;font-weight:700>)</span> <span style=color:#080;font-style:italic># On Minikube. Use: `kubectl cluster-info` on others K8s clusters</span>
   <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;ASP.NET Core URL: http://aspnet-core.local&#34;</span>
   <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$CLUSTER_IP</span><span style=color:#b44>  aspnet-core.local&#34;</span> | sudo tee -a /etc/hosts

2. Access ASP.NET Core using the obtained URL.
</code></pre></div><ol start=3>
<li>运行 helm history 命令，再次查看有关 drone-webapp 的历史记录信息</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm <span style=color:#a2f>history</span> drone-webapp
REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION
<span style=color:#666>1</span>               Thu Dec  <span style=color:#666>9</span> 14:59:26 <span style=color:#666>2021</span>        superseded      aspnet-core-1.3.18      0.0.1           Install <span style=color:#a2f>complete</span>
<span style=color:#666>2</span>               Thu Dec  <span style=color:#666>9</span> 15:08:18 <span style=color:#666>2021</span>        deployed        aspnet-core-1.3.18      0.0.2           Upgrade <span style=color:#a2f>complete</span>
</code></pre></div><h3 id=回滚-helm-发布>回滚 Helm 发布</h3>
<p>假设升级发布后，许多客户报告了关于网站的错误。 团队要求将发布回滚到应用的早期稳定版本。</p>
<ol>
<li>使用 helm rollback 命令来回滚应用。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm rollback drone-webapp <span style=color:#666>1</span>
Rollback was a success! Happy Helming!
</code></pre></div><ol start=2>
<li>回滚完成后，使用 helm history 命令查看 Helm 部署历史记录</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>izhao_yiyi@Azure:~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src$ helm <span style=color:#a2f>history</span> drone-webapp
REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION
<span style=color:#666>1</span>               Thu Dec  <span style=color:#666>9</span> 14:59:26 <span style=color:#666>2021</span>        superseded      aspnet-core-1.3.18      0.0.1           Install <span style=color:#a2f>complete</span>
<span style=color:#666>2</span>               Thu Dec  <span style=color:#666>9</span> 15:08:18 <span style=color:#666>2021</span>        superseded      aspnet-core-1.3.18      0.0.2           Upgrade <span style=color:#a2f>complete</span>
<span style=color:#666>3</span>               Thu Dec  <span style=color:#666>9</span> 15:08:50 <span style=color:#666>2021</span>        deployed        aspnet-core-1.3.18      0.0.1           Rollback to <span style=color:#666>1</span>
</code></pre></div><p>注意，列表中的最后一项显示以下信息：</p>
<ul>
<li>
<p>递增的修订号</p>
</li>
<li>
<p>回滚发布的应用版本号</p>
</li>
<li>
<p>回滚发布修订号的说明</p>
</li>
</ul>
<h2 id=实验环境删除>实验环境删除</h2>
<p>通过运行以下命令来删除所做的任何更改：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd ~ &amp;&amp; \
   rm -rf ~/clouddrive/mslearn-aks &amp;&amp; \
   az group delete --name learn-helm-deploy-aks-rg --yes

</code></pre></div><h2 id=本实验使用的所有命令>本实验使用的所有命令</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>SubscriptionId</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>az account list --query <span style=color:#b44>&#39;[0].id&#39;</span> -o tsv<span style=color:#a2f;font-weight:700>)</span>
. &lt;<span style=color:#666>(</span>wget -q -O - &lt;https://raw.githubusercontent.com/MicrosoftDocs/mslearn-aks/main/infrastructure/setup/setup.sh&gt; <span style=color:#666>)</span> -s <span style=color:#b8860b>$SubscriptionId</span> -n learn-helm-deploy-aks --use-acr <span style=color:#a2f>false</span> --install-dot-net <span style=color:#a2f>false</span>
helm repo add azure-marketplace https://marketplace.azurecr.io/helm/v1/repo
helm repo list
helm search repo aspnet
helm install aspnet-webapp azure-marketplace/aspnet-core
helm list
helm get manifest aspnet-webapp
kubectl get pods -o wide -w
helm delete aspnet-webapp
helm install --set <span style=color:#b8860b>replicaCount</span><span style=color:#666>=</span><span style=color:#666>5</span> aspnet-webapp azure-marketplace/aspnet-core
ls <span style=color:#b8860b>$HOME</span>/.cache/helm/repository -l
<span style=color:#a2f>cd</span> ~/clouddrive/mslearn-aks/modules/learn-helm-deploy-aks/src
find drone-webapp-chart/ -print
vim drone-webapp-chart/Chart.yaml
helm dependency build ./drone-webapp-chart
find drone-webapp-chart/ -print
gzip -dc ./drone-webapp-chart/charts/common-1.10.3.tgz | tar -xf - -C ./drone-webapp-chart/charts/
find drone-webapp-chart/ -print
cat ~/clouddrive/mslearn-aks/create-aks-exports.txt
helm <span style=color:#a2f>history</span> drone-webapp
helm upgrade drone-webapp ./drone-webapp-chart
helm rollback drone-webapp <span style=color:#666>1</span>
<span style=color:#a2f>cd</span> ~ <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>   rm -rf ~/clouddrive/mslearn-aks <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>   az group delete --name learn-helm-deploy-aks-rg --yes
</code></pre></div>
</div>
<footer class=post-footer>
<div id=wcomments></div>
</footer>
</article>
</section>
</div>
</div>
<div class=sidebar-toggle>
<div class=sidebar-toggle-line-wrap>
<span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
</div>
</div>
<aside id=sidebar class=sidebar>
<div class=sidebar-inner>
<ul class="sidebar-nav motion-element">
<li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>
文章目录
</li>
<li class=sidebar-nav-overview data-target=site-overview>
站点概览
</li>
</ul>
<section class="site-overview sidebar-panel">
<div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person>
<img class=site-author-image itemprop=image src=/img/avatar.png alt=Etaon>
<p class=site-author-name itemprop=name>Etaon</p>
<p class="site-description motion-element" itemprop=description>
Kepp Going!
</p>
</div>
<nav class="site-state motion-element">
<div class="site-state-item site-state-posts">
<a href=/post/>
<span class=site-state-item-count>61</span>
<span class=site-state-item-name>日志</span>
</a>
</div>
<div class="site-state-item site-state-categories">
<a href=/categories/>
<span class=site-state-item-count>13</span>
<span class=site-state-item-name>分类</span>
</a>
</div>
<div class="site-state-item site-state-tags">
<a href=/tags/>
<span class=site-state-item-count>34</span>
<span class=site-state-item-name>标签</span>
</a>
</div>
</nav>
<div class="links-of-author motion-element">
<span class=links-of-author-item>
<a href=https://github.com/etaon target=_blank title=GitHub>
<i class="fa fa-fw fa-github"></i>
GitHub
</a>
</span>
<span class=links-of-author-item>
<a href=https://blog.csdn.net/weixin_43394724 target=_blank title=CSDN>
<i class="fa fa-fw fa-CSDN"></i>
CSDN
</a>
</span>
</div>
<div class="links-of-blogroll motion-element links-of-blogroll-inline">
<div class=links-of-blogroll-title>
<i class="fa fa-fw fa-globe"></i>
友情链接
</div>
<ul class=links-of-blogroll-list>
<li class=links-of-blogroll-item>
<a href=https://kubernetes.io/ title=Kubernetes target=_blank>Kubernetes</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://cisco.com/ title=Cisco target=_blank>Cisco</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://www.w3school.com.cn/ title=W3School target=_blank>W3School</a>
</li>
<li class=links-of-blogroll-item>
<a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a>
</li>
</ul>
</div>
<div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline">
<div class=tagcloud-of-blogroll-title>
<i class="fa fa-fw fa-tags"></i>
标签云
</div>
<ul class=tagcloud-of-blogroll-list>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/mysql>Mysql</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/aws>Aws</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/dql>Dql</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/hadoop>Hadoop</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/redis>Redis</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/cicd>Cicd</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/git>Git</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/istio>Istio</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/mongodb>Mongodb</a>
</li>
<li class=tagcloud-of-blogroll-item>
<a href=/tags/azure>Azure</a>
</li>
</ul>
</div>
</section>
<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
<div class=post-toc>
<div class=post-toc-content><nav id=TableOfContents>
<ul>
<li><a href=#概述>概述</a>
<ul>
<li><a href=#helm-客户端>Helm 客户端</a></li>
<li><a href=#chart><strong>Chart</strong></a></li>
<li><a href=#release>R<strong>elease</strong></a></li>
<li><a href=#helm-仓库存储库>Helm 仓库/存储库</a></li>
</ul>
</li>
<li><a href=#helm-如何处理chart><strong>Helm 如何处理chart</strong></a>
<ul>
<li><a href=#定义-chartyaml-文件><strong>定义 Chart.yaml 文件</strong></a></li>
<li><a href=#定义chart模板><strong>定义chart模板</strong></a></li>
<li><a href=#定义-valuesyaml-文件><strong>定义 values.yaml 文件</strong></a></li>
</ul>
</li>
<li><a href=#实验环境>实验环境</a>
<ul>
<li><a href=#运行部署脚本>运行部署脚本</a></li>
</ul>
</li>
<li><a href=#安装-helm-chart>安装 Helm chart</a>
<ul>
<li><a href=#提取-helm-chart>提取 Helm chart</a></li>
<li><a href=#部署-helm-chart>部署 Helm chart</a></li>
<li><a href=#使用设置的值安装-helm-chart>使用设置的值安装 Helm chart</a></li>
</ul>
</li>
<li><a href=#管理-helm-发布>管理 Helm 发布</a>
<ul>
<li><a href=#查看-helm-chart文件夹结构>查看 Helm chart文件夹结构</a></li>
<li><a href=#查看chart-valuesyaml-文件>查看chart values.yaml 文件</a></li>
<li><a href=#查看-deploymentyaml-和-ingressyaml-模板文件>查看 deployment.yaml 和 ingress.yaml 模板文件</a></li>
<li><a href=#部署-helm-chart-1>部署 Helm chart</a></li>
<li><a href=#升级-helm-发布>升级 Helm 发布</a></li>
<li><a href=#回滚-helm-发布>回滚 Helm 发布</a></li>
</ul>
</li>
<li><a href=#实验环境删除>实验环境删除</a></li>
<li><a href=#本实验使用的所有命令>本实验使用的所有命令</a></li>
</ul>
</nav></div>
</div>
</section>
</div>
</aside>
</div>
</main>
<footer id=footer class=footer>
<div class=footer-inner>
<div class=copyright>
<span class=copyright-year>
&copy; 2010 - 2022
</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>路无止境！</span>
</div>
<div class=powered-info>
<span class=powered-by>
Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.91.2</a>
</span>
<span class=separator-line>/</span>
<span class=theme-info>
Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank> NexT
</a>
</span>
</div>
<div class=vistor-info>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv>
<i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span>
</span>
<span class=separator-line>/</span>
<span class=site-pv>
<i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span>
</span>
</div>
<div class=license-info>
<span class=storage-info>
Storage by
<a href=https://www.azure.com/ style=font-weight:700 target=_blank>Azure static web apps</a>
</span>
<span class=separator-line>/</span>
<span class=license-num>
<a href target=_blank></a>
</span>
</div>
</div>
</footer>
<div class=back-to-top>
<i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span>
</div>
</div>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script>
<script type=text/javascript src=/js/search.js></script>
<script type=text/javascript src=/js/affix.js></script>
<script type=text/javascript src=/js/scrollspy.js></script>
<script type=text/javascript>function detectIE(){var a=window.navigator.userAgent,b=a.indexOf('MSIE '),c=a.indexOf('Trident/'),d=a.indexOf('Edge/');return b>0||c>0||d>0?-1:1}function getCntViewHeight(){var b=$('#content').height(),a=$(window).height(),c=b>a?b-a:$(document).height()-a;return c}function getScrollbarWidth(){var a=$('<div />').addClass('scrollbar-measure').prependTo('body'),b=a[0],c=b.offsetWidth-b.clientWidth;return a.remove(),c}function registerBackTop(){var b=50,a=$('.back-to-top');$(window).on('scroll',function(){var d,e,f,c,g;a.toggleClass('back-to-top-on',window.pageYOffset>b),d=$(window).scrollTop(),e=getCntViewHeight(),f=d/e,c=Math.round(f*100),g=c>100?100:c,$('#scrollpercent>span').html(g)}),a.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var a='.post-toc',d=$(a),b='.active-current';d.on('activate.bs.scrollspy',function(){var b=$(a+' .active').last();c(),b.addClass('active-current')}).on('clear.bs.scrollspy',c),$('body').scrollspy({target:a});function c(){$(a+' '+b).removeClass(b.substring(1))}}function initAffix(){var a=$('.header-inner').height(),b=parseInt($('.main').css('padding-bottom'),10),c=a+10;$('.sidebar-inner').affix({offset:{top:c,bottom:b}}),$(document).on('affixed.bs.affix',function(){updateTOCHeight(document.body.clientHeight-100)})}function initTOCDimension(){var a,b;$(window).on('resize',function(){a&&clearTimeout(a),a=setTimeout(function(){var a=document.body.clientHeight-100;updateTOCHeight(a)},0)}),updateTOCHeight(document.body.clientHeight-100),b=getScrollbarWidth(),$('.post-toc').css('width','calc(100% + '+b+'px)')}function updateTOCHeight(a){a=a||'auto',$('.post-toc').css('max-height',a)}$(function(){var b=$('.header-inner').height()+10,c,d,a,e;$('#sidebar').css({'margin-top':b}).show(),c=parseInt($('#sidebar').css('margin-top')),d=parseInt($('.sidebar-inner').css('height')),a=c+d,e=$('.content-wrap').height(),e<a&&$('.content-wrap').css('min-height',a),$('.site-nav-toggle').on('click',function(){var a=$('.site-nav'),e=$('.toggle'),b='site-nav-on',f='toggle-close',c=a.hasClass(b),g=c?'slideUp':'slideDown',d=c?'removeClass':'addClass';a.stop()[g]('normal',function(){a[d](b),e[d](f)})}),registerBackTop(),initScrollSpy(),initAffix(),initTOCDimension(),$('.sidebar-nav-toc').click(function(){$(this).addClass('sidebar-nav-active'),$(this).next().removeClass('sidebar-nav-active'),$('.'+$(this).next().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)}),$('.sidebar-nav-overview').click(function(){$(this).addClass('sidebar-nav-active'),$(this).prev().removeClass('sidebar-nav-active'),$('.'+$(this).prev().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)})})</script>
<script src=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js></script>
<script type=text/javascript>$(function(){$('.post-body').viewer()})</script>
<script type=text/javascript>$(function(){detectIE()>0?$.getScript(document.location.protocol+'//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js',function(){new Waline({el:'#wcomments',visitor:!0,avatar:'wavatar',avatarCDN:'https://sdn.geekzu.org/avatar/',avatarForce:!1,wordLimit:'200',placeholder:' 欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^ ',requiredFields:['nick','mail'],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$('#wcomments').html('抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。')})</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var a=document.createElement('script'),c=window.location.protocol.split(':')[0],b;c==='https'?a.src='https://zz.bdstatic.com/linksubmit/push.js':a.src='http://push.zhanzhang.baidu.com/push.js',b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
</body>
</html>