<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>NSX-T 为vSphere with Tanzu提供网络支撑 - 路无止境！</title><meta name=keywords content="博客,架构师,思考,读书,笔记,技术,分享,云"><meta name=author content="Etaon"><meta property="og:title" content="NSX-T 为vSphere with Tanzu提供网络支撑"><meta property="og:site_name" content="路无止境！"><meta property="og:image" content="/img/author.jpg"><meta name=title content="NSX-T 为vSphere with Tanzu提供网络支撑 - 路无止境！"><meta name=description content="欢迎来到ETAON空间站，个人主要专注于Infra系统架构，私有/公有云产品，售前及微服务解决方案。"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css rel=stylesheet><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=multi-lang-switch><i class="fa fa-fw fa-language" style=margin-right:5px></i>
<a class=lang-link id=zh-cn href=#>学习</a></div><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>路无止境！</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>没有伞的孩子要学会努力奔跑!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline" style=font-weight:700><a class=post-title-link href=https://www.etaon.top/2021/12/17/nsx-tanzu.html itemprop=url>NSX-T 为vSphere with Tanzu提供网络支撑</a></h1></header><div class=post-body itemprop=articleBody><p>vSphere with Tanzu是VMware太平洋计划的后续命名，我们在前面的讨论过WCP平台的安装，即是现在的vSphere with Tanzu。该平台是vSphere 7+和NSX-T共同形成，本文我们主要讨论NSX-T在本平台的网络功能和特性。</p><h2 id=整体架构>整体架构</h2><p><img src="https://img-blog.csdnimg.cn/20210619103455207.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
vSphere with Tanzu 解决方案的基础是由 vSphere 7+、NSX-T 和 Storage 组成的 VMware SDDC 堆栈。该解决方案将 vSphere 集群转换为工作负载平台，每个 vSphere 集群都具有 Kubernetes 控制平面，称为主管集群 Supervisor Cluster。</p><p>主管集群控制平面包含很多不是 Kubernetes 的东西。V记扩展了 K8S 以支持通过 VM Operator API 部署 VM，同时，通过 Cluster API 部署 TKG&ndash;相对独立的K8S cluster。</p><h3 id=vsphere-with-tanzu工作模式>vSphere with Tanzu工作模式</h3><p><img src="https://img-blog.csdnimg.cn/2021061911274366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
主管集群允许 ITops 团队，使用熟悉的vCenter图形管理界面，将命名空间定义为管理单元，以定义资源约束、身份验证/RBAC 并隔离。 Devops 团队可以在命名空间中部署选择的工作负载，即 PODvm、TKG 集群和 VM。</p><h3 id=ip-地址设计>IP 地址设计</h3><h4 id=主管集群地址>主管集群地址</h4><p>当我们启用工作负载管理后（vCenter->Menu->Workload Management->ENABLE)，系统会建立三个管理VM，该地址和vCenter要有可达性，推荐和vCenter一个子网。
<img src="https://img-blog.csdnimg.cn/20210619105120728.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
如上图，系统要求输入起始的IP地址，一共要用到5个地址：</p><ul><li>每个Supervisor Control plane VM占一个，</li><li>一个用于控制平面的浮动IP，</li><li>一个用于滚动升级。</li></ul><p>启动好工作负载管理后，可以看到系统生成了三个VM Master节点，并把集群里的主机变成了Worker节点</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop ~]# kubectl get node -owide
</span></span><span style=display:flex><span>NAME                               STATUS   ROLES    AGE   VERSION               INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                 KERNEL-VERSION       CONTAINER-RUNTIME
</span></span><span style=display:flex><span>42326254b49605f5fca490fd3ad3229e   Ready    master   24d   v1.19.1+wcp.3         172.211.0.3      &lt;none&gt;        VMware Photon OS/Linux   4.19.174-4.ph3-esx   containerd://1.3.3
</span></span><span style=display:flex><span>4232d828e38d98c395daeed9950c8dbc   Ready    master   24d   v1.19.1+wcp.3         172.211.0.4      &lt;none&gt;        VMware Photon OS/Linux   4.19.174-4.ph3-esx   containerd://1.3.3
</span></span><span style=display:flex><span>4232e0c5ff1dcdaa3f535e4099456c2b   Ready    master   24d   v1.19.1+wcp.3         172.211.0.2      &lt;none&gt;        VMware Photon OS/Linux   4.19.174-4.ph3-esx   containerd://1.3.3
</span></span><span style=display:flex><span>esx-01a.corp.tanzu                 Ready    agent    24d   v1.19.1-sph-b0161d9   192.168.110.51   &lt;none&gt;        &lt;unknown&gt;                &lt;unknown&gt;            &lt;unknown&gt;
</span></span><span style=display:flex><span>esx-03a.corp.tanzu                 Ready    agent    24d   v1.19.1-sph-b0161d9   192.168.110.53   &lt;none&gt;        &lt;unknown&gt;                &lt;unknown&gt;            &lt;unknown&gt;
</span></span><span style=display:flex><span>esx-05a.corp.tanzu                 Ready    agent    24d   v1.19.1-sph-b0161d9   192.168.110.55   &lt;none&gt;        &lt;unknown&gt;                &lt;unknown&gt;            &lt;unknown&gt;
</span></span><span style=display:flex><span>esx-06a.corp.tanzu                 Ready    agent    24d   v1.19.1-sph-b0161d9   192.168.110.56   &lt;none&gt;        &lt;unknown&gt;                &lt;unknown&gt;            &lt;unknown&gt;
</span></span></code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210619112507692.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
本例里，我们使用192.168.110.91为起始主管集群控制VM地址。</p><h4 id=主管集群ipam>主管集群IPAM</h4><p>主管集群会用到四组IP地址段
<img src="https://img-blog.csdnimg.cn/20210619111100613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><table><thead><tr><th>名称</th><th>说明</th><th>本实验使用</th><th>备注</th></tr></thead><tbody><tr><td>Pods</td><td>命名空间中工作负载的私有 IPv4 地址池，为pod提供地址</td><td>172.211.0.0/16</td><td></td></tr><tr><td>Services</td><td>服务 IPv4 地址池，用于通过 K8s ClusterIP 在<strong>命名空间内</strong>的服务</td><td>172.96.0.0/16</td><td></td></tr><tr><td>Ingress</td><td>公共 IPv4 地址池，通过 K8s 类型负载均衡器、Ingress 和 Cloudprovider 负载均衡器，为Tanzu Kubernetes 集群和 Supervisor 集群提供 Supervisor 集群之外的服务</td><td>172.80.0.0/16</td><td></td></tr><tr><td>Egress</td><td>公共 IPv4 地址池，用于 Supervisor 集群向外的 NAT 流量</td><td>172.60.0.0/16</td><td></td></tr></tbody></table><h3 id=主管集群的路由及分段设计>主管集群的路由及分段设计</h3><p><img src="https://img-blog.csdnimg.cn/20210619113502414.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><ul><li>主管集群内的为每个Namespace提供一个共享T1网关，该网关为vSphere pod和该Namespace上运行的TKG提供网络服务</li><li>在以上T1网关上，为vSphere pod分配一个分段，每个TKG集群分配一个分段</li><li>Supervisor Cluster的控制平面VM独享一个T1网关并分配一个分段</li><li>TKG集群内部的网络使用Calico或Antrea（默认）
<img src="https://img-blog.csdnimg.cn/20210619120609854.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=NSX-T网络拓扑截图></li></ul><h2 id=详细设计>详细设计</h2><h3 id=nsx-t-for-supervisor-cluster>NSX-T for Supervisor Cluster</h3><p>系统逻辑图
<img src="https://img-blog.csdnimg.cn/20210619124930686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>对于主管集群中的Cluster，每个Namespace分配一个分段。NSX-T为Namespace里的vSphere pod分配IP地址。
<img src="https://img-blog.csdnimg.cn/20210619171005618.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><h4 id=vsphere-pod网络>vSphere pod网络</h4><p>vSphere with Tanzu 引入了一个名为 vSphere Pod 的新构造，它等效于 Kubernetes Pod。vSphere Pod 是一个占用空间较小的<strong>虚拟机</strong>，可运行一个或多个 Linux 容器。每个 vSphere Pod 根据其容纳的工作负载精确地调整大小，并拥有与该工作负载对应的确切资源预留。
<img src="https://img-blog.csdnimg.cn/20210619184820196.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><p>在我们的环境中，namespace ns-dev上已经构建了两个Deployment，每个deployment运行一个pod</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl get deployment
</span></span><span style=display:flex><span>NAME              READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>wordpress         1/1     1            1           19d
</span></span><span style=display:flex><span>wordpress-mysql   1/1     1            1           19d
</span></span><span style=display:flex><span>[root@hop tanzu]# kubectl get po -owide
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE     IP             NODE                 NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>wordpress-79d67b9cf-j2vv2          1/1     Running   0          7d22h   172.211.0.18   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>wordpress-mysql-584b74f6b4-g5tg7   1/1     Running   0          7d22h   172.211.0.19   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Pod的IP地址为172.211.0.18/28和172.211.0.19/28，属于我们配置中设定的pods IP地址范围。（子网范围根据启动工作负载时选择的大小，系统自动确定）</p><p>而在namespace ns-prod上，也启动了一个deployment</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl get deployment
</span></span><span style=display:flex><span>NAME          READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>nginx-local   1/1     1            1           2m27s
</span></span><span style=display:flex><span>[root@hop tanzu]# kubectl get po -owide
</span></span><span style=display:flex><span>NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE            NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>nginx-local-6f498bf5c4-zbxmz   1/1     Running   0          2m36s   172.211.0.130   esx-01a.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Pod的IP地址为172.211.0.130/28.
我们可以在NSX-T上查看网络拓扑：
<img src="https://img-blog.csdnimg.cn/20210619185200157.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
除了 <em>pod</em> :nginx-local-6f498bf5c4-zbxmz，还有一个<em>VM</em>:nginx-local-6f498bf5c4-zbxmz。这就证明了vSphere Pod是一个瘦虚机，也是一个胖容器。</p><p>从拓扑中也可以清楚的看到NSX-T和vSphere with Tanzu形成的T1/Segment结构。</p><h4 id=nsx-t提供对外ingress和egress>NSX-T提供对外Ingress和Egress</h4><p>我们可以在配置Service的时候，将Ingress和服务类型写作LoadBalancer，例如
<img src=https://img-blog.csdnimg.cn/20210619190903770.png alt=在这里插入图片描述>
在实验环境里我们利用NSX-T的LoadBalancer对外提供Wordpress 站点(ns-dev)：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl config use-context ns-dev
</span></span><span style=display:flex><span>Switched to context &#34;ns-dev&#34;.
</span></span><span style=display:flex><span>[root@hop tanzu]# kubectl get svc
</span></span><span style=display:flex><span>NAME                                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
</span></span><span style=display:flex><span>my-cluster-01-control-plane-service    LoadBalancer   172.96.1.57    172.80.88.2   6443:32067/TCP   24d
</span></span><span style=display:flex><span>tkg-cluster-01-control-plane-service   LoadBalancer   172.96.0.165   172.80.88.3   6443:30862/TCP   23d
</span></span><span style=display:flex><span>wordpress                              LoadBalancer   172.96.1.90    172.80.88.5   80:32665/TCP     19d
</span></span><span style=display:flex><span>wordpress-mysql                        ClusterIP      None           &lt;none&gt;        3306/TCP         19d
</span></span></code></pre></div><p>在ns-dev这个namespace里，我们看到service：wordpress启用了对外LoadBalancer ，其地址为172.96.1.90（内部），和Ingress172.80.88.5（外部），符合我们前面地址段的设置。
再到与T0对接的路由器上，我们查询路由：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>S&gt;* 0.0.0.0/0 [1/0] via 192.168.0.1, eth0, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 10.10.20.0/24 is directly connected, eth1, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 10.10.30.0/24 is directly connected, eth1, 05w4d06h
</span></span><span style=display:flex><span>B&gt;* 172.8.253.34/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.10.0.0/24 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.60.96.1/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.60.96.2/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.60.96.3/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.60.96.4/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.60.96.5/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.80.88.1/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.80.88.2/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.80.88.3/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.80.88.4/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>B&gt;* 172.80.88.5/32 [20/0] via 192.168.100.3, eth1, 00:05:13
</span></span><span style=display:flex><span>C&gt;* 192.168.0.0/24 is directly connected, eth0, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.100.0/24 is directly connected, eth1, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.110.0/24 is directly connected, eth1, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.120.0/24 is directly connected, eth1.120, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.130.0/24 is directly connected, eth1.130, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.200.0/24 is directly connected, eth1, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.210.0/24 is directly connected, eth1.210, 05w4d06h
</span></span><span style=display:flex><span>C&gt;* 192.168.220.0/24 is directly connected, eth1.220, 05w4d06h
</span></span></code></pre></div><p>172.80.88.5/32这个地址，T0以32位的形式通过eBGP传递出去。</p><p>打开http://172.80.88.5</p><p><img src="https://img-blog.csdnimg.cn/20210619194601701.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
服务正常。</p><p>同时，我们看到Egress的地址也传递了出来，这意味着pod本身和外界是可以通信的。
我们在pod上试试：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl get po -owide
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE   IP             NODE                 NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>wordpress-79d67b9cf-j2vv2          1/1     Running   0          8d    172.211.0.18   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>wordpress-mysql-584b74f6b4-g5tg7   1/1     Running   0          8d    172.211.0.19   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>[root@hop tanzu]# kubectl exec -it wordpress-79d67b9cf-j2vv2 -- bash
</span></span><span style=display:flex><span>root@wordpress-79d67b9cf-j2vv2:/# ping www.cisco.com
</span></span><span style=display:flex><span>PING e2867.dsca.akamaiedge.net (184.86.200.197): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 184.86.200.197: icmp_seq=0 ttl=38 time=55.811 ms
</span></span><span style=display:flex><span>64 bytes from 184.86.200.197: icmp_seq=1 ttl=38 time=229.560 ms
</span></span><span style=display:flex><span>64 bytes from 184.86.200.197: icmp_seq=2 ttl=38 time=50.351 ms
</span></span><span style=display:flex><span>64 bytes from 184.86.200.197: icmp_seq=3 ttl=38 time=132.945 ms
</span></span><span style=display:flex><span>^C--- e2867.dsca.akamaiedge.net ping statistics ---
</span></span><span style=display:flex><span>5 packets transmitted, 4 packets received, 20% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max/stddev = 50.351/117.167/229.560/72.647 ms
</span></span></code></pre></div><p>NSX-T的NAT上面查看该T1下的NAT规则，发现系统自动将对外流量的IP 源地址修改为172.60.96.2，这就是刚才在外界路由器上看到的由BGP传递出去的egress地址。
<img src="https://img-blog.csdnimg.cn/20210619193411676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
我们在说回Ingress，NSX-T上面可以看到负载均衡情况
<img src="https://img-blog.csdnimg.cn/20210619193735618.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><p>启用工作负载管理后，NCP 在 NSX 中创建两个负载均衡器：</p><ul><li>Distributed Load Balancer：在每个主管集群 POD 的每个 vNIC 级别上应用分布式负载均衡器。 它用于 ClusterIP 类型的 k8s 服务</li><li>Server Load Balancer：该负载均衡器附加到小/中/大等大小的主管集群的 T1 GW。 它用于 LoadBalancer 和 Ingress 类型的 k8s 服务。</li></ul><p>上面提到Worepress使用的LB属于DLB（Distributed Load Balancer），我们可以查询到它的细节
<img src="https://img-blog.csdnimg.cn/2021061919533270.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
ClusterIP，内部service地址：172.96.1.90，port：80等</p><h4 id=nsx-t为vsphere-with-tanzu提供安全特性>NSX-T为vSphere With Tanzu提供安全特性</h4><p><img src="https://img-blog.csdnimg.cn/20210619195906731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
<strong>NSX-T为vSphere pod 默认策略</strong>
NSX-T为Namespace提供Pod级别的安全保护，包括：</p><ul><li>南北向通信：
&ndash; 默认情况下拒绝外部流量进入命名空间
&ndash; 默认情况下允许来自命名空间的流量离开出口
&ndash; 默认情况下拒绝命名空间之间的流量</li><li>东西向通信
&ndash; 默认情况下允许内部命名空间通信</li></ul><p>我们的环境按照系统默认应该如下图
<img src="https://img-blog.csdnimg.cn/20210619201928189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
<strong>登录到Pod上验证</strong>
查看Namespace和pod运行</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl get po -n ns-prod -owide
</span></span><span style=display:flex><span>NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE            NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>nginx-local-6f498bf5c4-zbxmz   1/1     Running   0          3h49m   172.211.0.130   esx-01a.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>testbox                        1/1     Running   1          20m     172.211.0.132   esx-01a.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>[root@hop tanzu]# kubectl get po -n ns-dev -owide
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE   IP             NODE                 NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>testbox                            1/1     Running   1          27m   172.211.0.20   esx-01a.tanzu        &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>wordpress-79d67b9cf-j2vv2          1/1     Running   0          8d    172.211.0.18   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>wordpress-mysql-584b74f6b4-g5tg7   1/1     Running   0          8d    172.211.0.19   esx-05a.corp.tanzu   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ul><li>默认情况下拒绝外部流量进入命名空间</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# ping 172.211.0.18
</span></span><span style=display:flex><span>PING 172.211.0.18 (172.211.0.18) 56(84) bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 172.211.0.18 ping statistics ---
</span></span><span style=display:flex><span>3 packets transmitted, 0 received, 100% packet loss, time 2004ms
</span></span></code></pre></div><ul><li>默认情况下允许来自命名空间的流量离开出口
登录到pod：wordpress-79d67b9cf-j2vv2</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl exec -it wordpress-79d67b9cf-j2vv2  -- bash
</span></span></code></pre></div><p>Ping外部站点</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@wordpress-79d67b9cf-j2vv2:/# ping cisco.com
</span></span><span style=display:flex><span>PING cisco.com (72.163.4.185): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 72.163.4.185: icmp_seq=0 ttl=222 time=74.010 ms
</span></span><span style=display:flex><span>64 bytes from 72.163.4.185: icmp_seq=1 ttl=222 time=68.523 ms
</span></span><span style=display:flex><span>64 bytes from 72.163.4.185: icmp_seq=2 ttl=222 time=68.038 ms
</span></span><span style=display:flex><span>^C--- cisco.com ping statistics ---
</span></span><span style=display:flex><span>3 packets transmitted, 3 packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max/stddev = 68.038/70.190/74.010/2.708 ms
</span></span></code></pre></div><ul><li>默认情况下拒绝命名空间之间的流量</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@wordpress-79d67b9cf-j2vv2:/# ping 172.211.0.130
</span></span><span style=display:flex><span>PING 172.211.0.130 (172.211.0.130): 56 data bytes
</span></span><span style=display:flex><span>^C--- 172.211.0.130 ping statistics ---
</span></span><span style=display:flex><span>31 packets transmitted, 0 packets received, 100% packet loss
</span></span></code></pre></div><ul><li>默认情况下允许内部命名空间通信</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@wordpress-79d67b9cf-j2vv2:/# ping 172.211.0.19
</span></span><span style=display:flex><span>PING 172.211.0.19 (172.211.0.19): 56 data bytes
</span></span><span style=display:flex><span>64 bytes from 172.211.0.19: icmp_seq=0 ttl=64 time=2.726 ms
</span></span><span style=display:flex><span>64 bytes from 172.211.0.19: icmp_seq=1 ttl=64 time=0.875 ms
</span></span><span style=display:flex><span>64 bytes from 172.211.0.19: icmp_seq=2 ttl=64 time=0.598 ms
</span></span><span style=display:flex><span>^C--- 172.211.0.19 ping statistics ---
</span></span><span style=display:flex><span>3 packets transmitted, 3 packets received, 0% packet loss
</span></span><span style=display:flex><span>round-trip min/avg/max/stddev = 0.598/1.400/2.726/0.945 ms
</span></span></code></pre></div><p><strong>在NSX-T管理界面查看策略</strong>
以Namespace：ns-prod为例，我们可以看到以下发生作用的策略
<img src=https://img-blog.csdnimg.cn/2021061921423993.png alt=在这里插入图片描述></p><p><img src=https://img-blog.csdnimg.cn/20210619214137121.png alt=在这里插入图片描述>
打开允许的策略：
<em>目标：</em><img src="https://img-blog.csdnimg.cn/20210619214327736.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
生成在本分段的pod，以IP地址，分段和端口多次标注。
<em>源：</em>
<img src="https://img-blog.csdnimg.cn/2021061921453651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
Ingress的地址段，允许service访问
T1路由器
<img src="https://img-blog.csdnimg.cn/20210619214646195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
本分段地址写入白名单
<img src="https://img-blog.csdnimg.cn/20210619214716659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
Supervisor Cluster control plane VM</p><h4 id=inventory>Inventory</h4><p>在NSX-T 3.0+，提供对Container的监控
<img src="https://img-blog.csdnimg.cn/2021061921542350.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
我们可以看到在ns-dev下的pod情况</p><p><img src="https://img-blog.csdnimg.cn/20210619215503552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></p><h3 id=nsx-t-for-tanzu-kubernetes-cluster>NSX-T for Tanzu Kubernetes Cluster</h3><p><img src="https://img-blog.csdnimg.cn/20210619215748431.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
由上图可以看到，NSX-T为TK Cluster提供</p><ul><li>Node VM的连接，其IP地址分配和vSphere Pod同等级</li><li>Service：Type LB，同样使用Ingress定义的地址段
其他：</li><li>集群内部CNI：Antrea或Calico</li><li>Ingress：第三方ingress controller（NSX-T的Ingress不提供给TK Cluster）</li></ul><h4 id=node-vm的连接>Node VM的连接</h4><p>我们在ns-dev内起了TK Cluster：tkg-cluster-01
<img src="https://img-blog.csdnimg.cn/20210619220553784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
可以清楚的看到其处于的位置
<img src="https://img-blog.csdnimg.cn/20210619220743613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
vCenter上面可以查看到本集群的control-plane VM的IP地址172.211.0.71，与vSphere Pod共用pod地址池。</p><h4 id=cluster内部pod对外service-lb-验证>Cluster内部pod对外Service LB 验证</h4><p>在TK Cluster内部使用如下yaml建立deployment和service</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>imagePullSecrets</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>harbor-registry-secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#666>172.80.88.4</span>/ns-dev/hello-kubernetes:1.5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MESSAGE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>I just deployed a PodVM on the Tanzu Kubernetes Cluster!!<span style=color:#bbb>
</span></span></span></code></pre></div><p>此处使用了内部Harbor，请参考<a href=https://blog.csdn.net/weixin_43394724/article/details/117171464>如何在Tanzu Cluster中使用vSphere with Tanzu内置容器注册表</a></p><p>运行yaml以后</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@hop tanzu]# kubectl get svc
</span></span><span style=display:flex><span>NAME               TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span><span style=display:flex><span>hello-kubernetes   LoadBalancer   100.64.136.105   172.80.88.7   80:32762/TCP   38s
</span></span><span style=display:flex><span>kubernetes         ClusterIP      100.64.0.1      &lt;none&gt;        443/TCP        24d
</span></span><span style=display:flex><span>supervisor         ClusterIP      None            &lt;none&gt;        6443/TCP       24d
</span></span></code></pre></div><p>对外的服务生成，地址为172.80.88.7，使用nodePort:32762映射80
<img src="https://img-blog.csdnimg.cn/20210619224651575.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt></p><ul><li>工作节点使用 iptables 将服务暴露给 nodePort</li><li>NSX为服务创建虚拟服务器</li><li>具有特定 nodePort 的工作节点被设置为LB 池成员</li><li>Ingress控制器使用 LB 类型的服务来公开其 IP</li><li><img src="https://img-blog.csdnimg.cn/20210619230316632.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></li></ul><p><img src="https://img-blog.csdnimg.cn/20210619230017702.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzM5NDcyNA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述>
可以查看到Server Pool的情况，nodePort:32762</p><p>以上</p></div><footer class=post-footer><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=Etaon><p class=site-author-name itemprop=name>Etaon</p><p class="site-description motion-element" itemprop=description>Kepp Going!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>70</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>38</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/etaon target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://blog.csdn.net/weixin_43394724 target=_blank title=CSDN><i class="fa fa-fw fa-CSDN"></i>
CSDN</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://kubernetes.io/ title=Kubernetes target=_blank>Kubernetes</a></li><li class=links-of-blogroll-item><a href=https://cisco.com/ title=Cisco target=_blank>Cisco</a></li><li class=links-of-blogroll-item><a href=https://www.w3school.com.cn/ title=W3School target=_blank>W3School</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/mysql>Mysql</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/aws>Aws</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/dql>Dql</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/hadoop>Hadoop</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/redis>Redis</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/cicd>Cicd</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/git>Git</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/nsx-t>Nsx t</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/istio>Istio</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/mongodb>Mongodb</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#整体架构>整体架构</a><ul><li><a href=#vsphere-with-tanzu工作模式>vSphere with Tanzu工作模式</a></li><li><a href=#ip-地址设计>IP 地址设计</a></li><li><a href=#主管集群的路由及分段设计>主管集群的路由及分段设计</a></li></ul></li><li><a href=#详细设计>详细设计</a><ul><li><a href=#nsx-t-for-supervisor-cluster>NSX-T for Supervisor Cluster</a></li><li><a href=#nsx-t-for-tanzu-kubernetes-cluster>NSX-T for Tanzu Kubernetes Cluster</a></li></ul></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>路无止境！</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.101.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://www.azure.com/ style=font-weight:700 target=_blank>Azure static web apps</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href target=_blank></a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script>
<script type=text/javascript src=/js/search.js></script>
<script type=text/javascript src=/js/affix.js></script>
<script type=text/javascript src=/js/scrollspy.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".main").css("padding-bottom"),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}}),$(document).on("affixed.bs.affix",function(){updateTOCHeight(document.body.clientHeight-100)})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e,t,n,s,o=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":o}).show(),t=parseInt($("#sidebar").css("margin-top")),n=parseInt($(".sidebar-inner").css("height")),e=t+n,s=$(".content-wrap").height(),s<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initScrollSpy(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>$(function(){detectIE()>0?$.getScript(document.location.protocol+"//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,avatar:"wavatar",avatarCDN:"https://sdn.geekzu.org/avatar/",avatarForce:!1,wordLimit:"200",placeholder:" 欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^ ",requiredFields:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>